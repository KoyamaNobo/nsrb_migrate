000010 IDENTIFICATION    DIVISION.
000020 PROGRAM-ID.       PRG410.
000030********************************************
000040*****    月別消費税内訳ワーク　作成    *****
000050********************************************
000060 ENVIRONMENT       DIVISION.
000070 CONFIGURATION     SECTION.
000080 SOURCE-COMPUTER.  SYSTEM3100.
000090 OBJECT-COMPUTER.  SYSTEM3100.
000100 INPUT-OUTPUT      SECTION.
000110 FILE-CONTROL.
000120     SELECT  KNG     ASSIGN   TO   KNGF-MSD
000130                     ORGANIZATION  INDEXED
000140                     ACCESS  MODE  DYNAMIC
000150                     RECORD  KEY   KNG-KEY.
000160     SELECT  AM      ASSIGN   TO   AM-MSD
000170                     ORGANIZATION  INDEXED
000180                     ACCESS  MODE  DYNAMIC
000190                     RECORD  KEY   AM-KEY.
000200     SELECT  FCTL-F  ASSIGN   TO   FCTLF-MSD
000210                     ORGANIZATION  INDEXED
000220                     ACCESS  MODE  RANDOM
000230                     RECORD  KEY   FCTL-KEY.
000240     SELECT  SDH     ASSIGN   TO   SDH-MSD
000250                     ORGANIZATION  INDEXED
000260                     ACCESS  MODE  DYNAMIC
000270                     RECORD  KEY   SH-KEY3.
000280     SELECT  SZF     ASSIGN   TO   SZ-MSD.
000290 I-O-CONTROL.
000300     APPLY  SHARED-MODE  ON  KNG
000310     APPLY  SHARED-MODE  ON  AM
000320     APPLY  SHARED-MODE  ON  SDH
000330     APPLY  SHARED-MODE  ON  FCTL-F.
000340 DATA        DIVISION.
000350 FILE        SECTION.
000360     COPY  KANGEL.
000370     COPY  ACCUNT.
000380     COPY  FCTL.
000390 FD  SDH
000400     BLOCK CONTAINS 3 RECORDS
000410     LABEL RECORD STANDARD
000420     VALUE OF IDENTIFICATION "SIWAKE-H3".
000430     COPY  SIWAKH.
000440 FD  SZF
000450     BLOCK  1 RECORDS
000460     LABEL RECORD STANDARD
000470     VALUE OF IDENTIFICATION WK0512ID.
000480 01  SZ-R.
000490     02  SZ-KEY.
000500       03  SZ-KMK      PIC  9(004).
000510       03  SZ-HOJ      PIC  9(004).
000520     02  SZ-TUKI.
000530       03  SZ-TUKID   OCCURS  12.
000540         04  SZ-NKIN   PIC S9(009).
000550         04  SZ-NSHZ   PIC S9(008).
000560         04  SZ-OKIN   PIC S9(008).
000570         04  SZ-OSHZ   PIC S9(007).
000580         04  SZ-HKIN   PIC S9(009).
000590     02  SZ-TSC        PIC  9(001).
000600     02  F             PIC  X(011).
000610 WORKING-STORAGE       SECTION.
000620 77  WK0512ID           PIC  X(009) VALUE SPACE.
000630 01  STN-NO.
000640     02  STN-NO1        PIC  X(003).
000650     02  STN-NO2        PIC  X(003).
000660 01  W-FID.
000670     02  W-FID1         PIC  X(006) VALUE "WK0512".
000680     02  W-FID2         PIC  X(003).
000690 01  ERR-STAT           PIC  X(002).
000700 01  W-DATA.
000710     02  W-NGP.
000720*****  03  W-NEN        PIC  9(002).                              D.971114
000730       03  W-NEN        PIC  9(004).                              I.971114
000740       03  W-NENL  REDEFINES W-NEN.                               I.971114
000750         04  W-NEN1     PIC  9(002).                              I.971114
000760         04  W-NEN2     PIC  9(002).                              I.971114
000770       03  W-GET        PIC  9(002).
000780       03  W-PEY        PIC  9(002).
000790     02  W-SED.
000800       03  W-SNGP       PIC  9(008).                              I.971114
000810       03  W-ENGP       PIC  9(008).                              I.971114
000820*****  03  W-SNGP       PIC  9(006).                              D.971114
000830*****  03  W-ENGP       PIC  9(006).                              D.971114
000840     02  W-DMM          PIC  9(001).
000850     02  W-KMK.
000860       03  W-KMK1       PIC  9(004).
000870       03  W-KMK2       PIC  9(004).
000880     02  CNT            PIC  9(002).
000890 SCREEN          SECTION.
000900 SD  C-CRT
000910     END STATUS  IS    ESTAT.
000920 01  C-CLEAR.
000930     02  C-CL     LINE   1  CLEAR  SCREEN.
000940 01  C-MID.
000950     02  LINE   3  COLUMN  15  PIC  N(023) VALUE
000960          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
000970     02  LINE   4  COLUMN  15  PIC  N(023) VALUE
000980          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
000990     02  LINE   5  COLUMN  15  PIC  N(023) VALUE
001000          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
001010     02  LINE   6  COLUMN  15  PIC  N(023) VALUE
001020          NC"＊＊＊　　月別消費税内訳ワーク　作成　　＊＊＊".
001030     02  LINE   7  COLUMN  15  PIC  N(023) VALUE
001040          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
001050     02  LINE   8  COLUMN  15  PIC  N(023) VALUE
001060          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
001070     02  LINE   9  COLUMN  15  PIC  N(023) VALUE
001080          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001090     02  LINE  15  COLUMN  31  PIC  X(015) VALUE
001100          "【　'  年度  】".
001110     02  LINE  20  COLUMN  29  PIC  X(022) VALUE
001120          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001130 01  C-DSP.
001140     02  D-NEN   LINE  15  COLUMN  36  PIC  9(002) FROM  W-NEN2.  I.971114
001150*****02  D-NEN   LINE  15  COLUMN  36  PIC  9(002) FROM  W-NEN.   D.971114
001160 01  C-ACP.
001170     02  A-DMM   LINE  20  COLUMN  46  PIC  9(001)
001180          USING W-DMM   CHECK OVERFLOW NO IFC.
001190 01  C-ERR   LINE  24.
001200     02  E-ME1.
001210       03  COLUMN  15  PIC  X(032) VALUE
001220            "***  ｺﾝﾄﾛｰﾙﾌｧｲﾙ ﾅｼ (      )  ***".
001230       03  COLUMN  35  PIC  X(006) FROM  FCTL-KEY.
001240     02  E-ME2.
001250       03  COLUMN  15  PIC  X(036) VALUE
001260            "***  ｶﾝｼﾞｶﾓｸﾏｽﾀ- ﾅｼ  (        )  ***".
001270       03  COLUMN  37  PIC  X(008) FROM  KNG-KEY.
001280     02  E-ME3.
001290       03  COLUMN  15  PIC  X(028) VALUE
001300            "***  ｶﾓｸﾏｽﾀ- ﾅｼ  (    )  ***".
001310       03  COLUMN  33  PIC  X(004) FROM  AM-KEY.
001320     02  E-ME98  COLUMN  75  PIC  X(005) VALUE ""27"J"05"".
001330     02  E-ME99  COLUMN  75  PIC  X(005) VALUE ""27"B"05"".
001340 PROCEDURE      DIVISION.
001350 M-05.
001360     OPEN INPUT FCTL-F.
001370     MOVE "DATE  " TO FCTL-KEY.
001380     READ FCTL-F UNLOCK INVALID
001390         DISPLAY E-ME1 E-ME99
001400         CLOSE FCTL-F
001410         STOP RUN.
001420     MOVE FCTL-UPDYY TO W-NEN.
001430     COMPUTE W-GET = FCTL-KSMM + 1.
001440     IF W-GET = 13
001450         MOVE 1 TO W-GET.
001460     MOVE FCTL-TOUF(W-GET) TO W-SNGP.
001470     MOVE FCTL-TOUT(FCTL-KSMM) TO W-ENGP.
001480*
001490     MOVE "TAX   " TO FCTL-KEY.
001500     READ FCTL-F UNLOCK INVALID
001510         DISPLAY E-ME1 E-ME99
001520         CLOSE FCTL-F
001530         STOP RUN.
001540     MOVE TAX-CODE TO W-KMK1.
001550     MOVE TAX-CODE1 TO W-KMK2.
001560     CLOSE FCTL-F.
001570*
001580     DISPLAY C-CLEAR.
001590     DISPLAY C-MID.
001600     DISPLAY D-NEN.
001610 M-10.
001620     ACCEPT A-DMM.
001630     IF ESTAT = "P9"
001640         MOVE 255 TO COMPLETION-CODE
001650         DISPLAY C-CLEAR
001660         STOP RUN.
001670     IF ESTAT NOT = "01" AND "06"
001680         GO TO M-10.
001690     IF W-DMM = 9
001700         MOVE 255 TO COMPLETION-CODE
001710         DISPLAY C-CLEAR
001720         STOP RUN.
001730     IF W-DMM NOT = 1
001740         GO TO M-10.
001750*
001760     CALL "CBLSTNNO" USING STN-NO.
001770     MOVE STN-NO2 TO W-FID2.
001780     MOVE W-FID TO WK0512ID.
001790     OPEN INPUT KNG AM SDH.
001800     OPEN OUTPUT SZF.
001810 M-15.
001820     READ SDH NEXT RECORD AT END
001830         GO TO M-95.
001840*****IF HTRDATE3 < W-SNGP OR > W-ENGP                             D.980224
001850     IF HTRDATE  < W-SNGP OR > W-ENGP                             I.980224
001860         GO TO M-15.
001870     IF HACCNTCD = W-KMK1 OR W-KMK2
001880         GO TO M-15.
001890     IF HTAXKB NOT = " "
001900         GO TO M-20.
001910     IF HETAX NOT = " "
001920         GO TO M-20.
001930*****MOVE HKACD3 TO KNG-KEY.                                      D.980224
001940     MOVE HKACD1 TO KNG-KEY.                                      I.980224
001950     READ KNG UNLOCK INVALID
001960         DISPLAY E-ME2 E-ME99
001970         GO TO M-95.
001980     IF KNGTAX = " "
001990         GO TO M-15.
002000 M-20.
002010     MOVE ZERO TO SZ-R.
002020*****MOVE HKACD3 TO SZ-KEY.                                       D.980224
002030     MOVE HKACD1 TO SZ-KEY.                                       I.980224
002040     MOVE SZ-KMK TO AM-KEY.
002050     READ AM UNLOCK INVALID
002060         DISPLAY E-ME3 E-ME99
002070         GO TO M-95.
002080     MOVE DR-CR TO SZ-TSC.
002090 M-25.
002100*****MOVE HTRDATE3 TO W-NGP.                                      D.980224
002110     MOVE HTRDATE  TO W-NGP.                                      I.980224
002120     IF W-GET < 5
002130         ADD 12 TO W-GET.
002140     COMPUTE CNT = W-GET - 4.
002150     IF HTAXKB = "3" OR "7"
002160         IF HDR-CR = DR-CR
002170             ADD HAMOUNT TO SZ-NKIN(CNT)
002180           ELSE
002190             SUBTRACT HAMOUNT FROM SZ-NKIN(CNT).
002200     IF HTAXKB = "1" OR "5"
002210         IF HDR-CR = DR-CR
002220             ADD HAMOUNT TO SZ-OKIN(CNT)
002230           ELSE
002240             SUBTRACT HAMOUNT FROM SZ-OKIN(CNT).
002250     IF HTAXKB NOT = " "
002260         GO TO M-30.
002270     IF HETAX = " "
002280         IF HDR-CR = DR-CR
002290             ADD HAMOUNT TO SZ-HKIN(CNT)
002300           ELSE
002310             SUBTRACT HAMOUNT FROM SZ-HKIN(CNT).
002320     IF HETAX = "3" OR "7"
002330         IF HDR-CR = DR-CR
002340             ADD HAMOUNT TO SZ-NKIN(CNT)
002350             SUBTRACT HAMOUNT FROM SZ-NSHZ(CNT)
002360           ELSE
002370             SUBTRACT HAMOUNT FROM SZ-NKIN(CNT)
002380             ADD HAMOUNT TO SZ-NSHZ(CNT).
002390     IF HETAX = "1" OR "5"
002400         IF HDR-CR = DR-CR
002410             ADD HAMOUNT TO SZ-OKIN(CNT)
002420             SUBTRACT HAMOUNT FROM SZ-OSHZ(CNT)
002430           ELSE
002440             SUBTRACT HAMOUNT FROM SZ-OKIN(CNT)
002450             ADD HAMOUNT TO SZ-OSHZ(CNT).
002460 M-30.
002470     READ SDH NEXT RECORD AT END
002480         GO TO M-80.
002490*****IF HTRDATE3 < W-SNGP OR > W-ENGP                             D.980224
002500     IF HTRDATE  < W-SNGP OR > W-ENGP                             I.980224
002510         GO TO M-30.
002520     IF HACCNTCD = W-KMK1 OR W-KMK2
002530         GO TO M-30.
002540     IF HTAXKB NOT = " "
002550         GO TO M-35.
002560     IF HETAX NOT = " "
002570         GO TO M-35.
002580*****MOVE HKACD3 TO KNG-KEY.                                      D.980224
002590     MOVE HKACD1 TO KNG-KEY.                                      I.980224
002600     READ KNG UNLOCK INVALID
002610         DISPLAY E-ME2 E-ME99
002620         GO TO M-95.
002630     IF KNGTAX = " "
002640         GO TO M-30.
002650 M-35.
002660*****IF HKACD3 = SZ-KEY                                           D.980224
002670     IF HKACD1 = SZ-KEY                                           I.980224
002680         GO TO M-25.
002690     WRITE SZ-R.
002700     GO TO M-20.
002710 M-80.
002720     WRITE SZ-R.
002730 M-95.
002740     CLOSE KNG AM SDH.
002750     CLOSE SZF.
002760     DISPLAY C-CLEAR.
002770     STOP RUN.

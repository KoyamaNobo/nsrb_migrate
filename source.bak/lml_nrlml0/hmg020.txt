000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. HMG020.
000030*******************************************************************
000040*    担当得意先品種別売上集計表（ハイパーＶ）                     *
000050*******************************************************************
000060 ENVIRONMENT DIVISION.
000070 CONFIGURATION SECTION.
000080 SOURCE-COMPUTER. SYSTEM3100.
000090 OBJECT-COMPUTER. SYSTEM3100.
000100 INPUT-OUTPUT SECTION.
000110 FILE-CONTROL.
000120     COPY LIBCSE.
000130     SELECT T-M ASSIGN TO T1-MSD T2-MSD
000140         ORGANIZATION IS INDEXED
000150         ACCESS MODE IS RANDOM
000160         RECORD KEY IS T-KEY
000170         ALTERNATE RECORD KEY IS T-KEY2
000180         FILE STATUS IS ERR-STAT.
000190     SELECT HI-M ASSIGN TO HI1-MSD HI2-MSD
000200         ORGANIZATION IS INDEXED
000210         ACCESS MODE IS DYNAMIC
000220         RECORD KEY IS HI-KEY
000230         ALTERNATE RECORD KEY IS HI-KEY2
000240         FILE STATUS IS ERR-STAT.
000250     SELECT SNTRF ASSIGN TO SNTR-MSD
000260         FILE STATUS IS ERR-STAT.
000270     SELECT SP-F ASSIGN TO P-PRN999.
000280 I-O-CONTROL.
000290     APPLY SHARED-MODE ON M-DATE
000300     APPLY SHARED-MODE ON T-M
000310     APPLY SHARED-MODE ON HI-M
000320     APPLY SHIFT-CODE  ON SP-F.
000330 DATA DIVISION.
000340 FILE SECTION.
000350     COPY LIBFDD.
000360     COPY LITM.
000370     COPY LIHIM.
000380     COPY LSSNTW.
000390     COPY LSPF.
000400 WORKING-STORAGE SECTION.
000410 77  WK0064ID           PIC  X(009) VALUE SPACE.
000420 01  STN-NO.
000430     02  STN-NO1        PIC  X(003).
000440     02  STN-NO2        PIC  X(003).
000450 01  W-FID.
000460     02  W-FID1         PIC  X(006) VALUE "WK0064".
000470     02  W-FID2         PIC  X(003).
000480 01  HEAD1.
000490     02  W-20K          PIC  X(005) VALUE ""3FE04FE080"".
000500     02  F              PIC  N(007) VALUE NC"【ハイパーＶ】".
000510     02  F              PIC  X(016) VALUE SPACE.
000520     02  F              PIC  N(024) VALUE
000530         NC"＊＊＊　　担当得意先品種別　売上集計表　　＊＊＊".
000540     02  F              PIC  X(018) VALUE SPACE.
000550     02  F              PIC  X(005) VALUE "DATE ".
000560     02  H-DATE         PIC 99B99B99.
000570     02  F              PIC  X(007) VALUE "     P.".
000580     02  H-PAGE         PIC Z9.
000590 01  HEAD2.
000600     02  W-15K          PIC  X(005) VALUE ""3FE04F40A0"".
000610     02  F              PIC  N(002) VALUE NC"担当".
000620     02  F              PIC  X(006) VALUE " ｺｰﾄﾞ ".
000630     02  F              PIC  N(008) VALUE NC"得　意　先　名　".
000640     02  F              PIC  X(028) VALUE SPACE.
000650     02  F              PIC  X(005) VALUE "ｺｰﾄﾞ ".
000660     02  F              PIC  N(008) VALUE NC"品　　　　　名　".
000670     02  F              PIC  X(026) VALUE SPACE.
000680     02  F              PIC  N(004) VALUE NC"　数　量".
000690     02  F              PIC  X(002) VALUE SPACE.
000700     02  F              PIC  N(004) VALUE NC"平均売価".
000710     02  F              PIC  X(006) VALUE SPACE.
000720     02  F              PIC  N(004) VALUE NC"　金　額".
000730 01  W-P.
000740     02  F              PIC  X(001).
000750     02  P-TNC          PIC  9(002).
000760     02  F              PIC  X(001).
000770     02  P-TCD          PIC  9(004).
000780     02  F              PIC  X(001).
000790     02  P-TNA          PIC  N(026).
000800     02  F              PIC  X(001).
000810     02  P-HCD1         PIC  9(004).
000820     02  F              PIC  X(001).
000830     02  P-HNA          PIC  N(024).
000840     02  P-SU           PIC ----,--9.
000850     02  P-UT           PIC ----,--9.
000860     02  P-KIN          PIC ----,---,--9.
000870 01  W-D.
000880     02  W-KEY.
000890       03  W-TCD        PIC  9(004).
000900       03  W-HCD1       PIC  9(004).
000910     02  W-TNC.
000920       03  W-TNC1       PIC  9(001).
000930       03  W-TNC2       PIC  9(001).
000940     02  W-UT           PIC S9(005).
000950     02  W-RD.
000960       03  W-SU         PIC S9(005).
000970       03  W-UKIN       PIC S9(008).
000980 01  WN-D.
000990     02  WN-SU          PIC S9(006).
001000     02  WN-UKI         PIC S9(009).
001010 01  WT-D.
001020     02  WT-SU          PIC S9(006).
001030     02  WT-UKI         PIC S9(009).
001040 01  WS-D.
001050     02  WS-SU          PIC S9(006).
001060     02  WS-UKI         PIC S9(009).
001070 01  WA-D.
001080     02  WA-SU          PIC S9(006).
001090     02  WA-UKI         PIC S9(009).
001100 01  W-DATA.
001110     02  W-PAGE         PIC  9(002).
001120     02  W-DC           PIC  9(003).
001130     02  CHK            PIC  9(001).
001140     02  W-C            PIC  9(001).
001150     02  W-DMM          PIC  9(001).
001160     02  W-SETC.
001170       03  W-STC        PIC  9(002).
001180       03  W-ETC        PIC  9(002) VALUE 99.                     I.151103
001190*****  03  W-ETC        PIC  9(002).                              D.151103
001200     02  CNT            PIC  9(002).
001210     02  W-NAME         PIC  N(024).
001220     02  W-ANAD  REDEFINES W-NAME.
001230       03  W-NAD   OCCURS  24.
001240         04  W-NA       PIC  N(001).
001250     02  W-HNA          PIC  N(024).
001260     02  W-AHND  REDEFINES W-HNA.
001270       03  W-AHNA  OCCURS  24.
001280         04  W-HNAD     PIC  N(001).
001290 01  ERR-STAT           PIC  X(002).
001300     COPY LSTAT.
001310 SCREEN SECTION.
001320 SD  C-CRT
001330     END STATUS IS ESTAT.
001340 01  C-CLEAR.
001350     02  C-CL    LINE   1  CLEAR SCREEN.
001360 01  C-MID.
001370     02  LINE   3  COLUMN  10  PIC  N(024) VALUE
001380          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001390     02  LINE   4  COLUMN  10  PIC  N(024) VALUE
001400          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001410     02  LINE   5  COLUMN  10  PIC  N(024) VALUE
001420          NC"＊＊＊　　　　　　　　　　　　　　　　　　＊＊＊".
001430     02  LINE   6  COLUMN  10  PIC  N(024) VALUE
001440          NC"＊＊＊　　担当得意先品種別　売上集計表　　＊＊＊".
001450     02  LINE   7  COLUMN  10  PIC  N(024) VALUE
001460          NC"＊＊＊　　　　　（ハイパーＶ）　　　　　　＊＊＊".
001470     02  LINE   8  COLUMN  10  PIC  N(024) VALUE
001480          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001490     02  LINE   9  COLUMN  10  PIC  N(024) VALUE
001500          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001510     02  LINE  15  COLUMN  24  PIC  X(020) VALUE
001520          "担当者ｺｰﾄﾞ  00 〜 99".
001530     02  LINE  20  COLUMN  23  PIC  X(022) VALUE
001540          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001550 01  C-ACP.
001560     02  LINE  15.
001570       03  A-STC   COLUMN  36  PIC  9(002)
001580            USING W-STC   CHECK OVERFLOW NO IFC.
001590       03  A-ETC   COLUMN  42  PIC  9(002)
001600            USING W-ETC   CHECK OVERFLOW NO IFC.
001610     02  A-DMM   LINE  20  COLUMN  40  PIC  9(001)
001620          USING W-DMM   CHECK OVERFLOW NO IFC.
001630 01  C-ERR.
001640     02  LINE  24.
001650       03  E-ME1   COLUMN  15  PIC  X(017) VALUE
001660            "***  DATA ﾅｼ  ***".
001670       03  E-ME2   COLUMN  15  PIC  X(017) VALUE
001680            "***  ﾋﾝﾒｲ ﾅｼ  ***".
001690       03  E-KEY   COLUMN  35  PIC  9(006) FROM  HI-HCD.
001700       03  E-ME98  COLUMN  75  PIC  X(005) VALUE ""27"J"05"".
001710       03  E-ME99  COLUMN  75  PIC  X(005) VALUE ""27"B"05"".
001720     COPY LIBSCR.
001730 PROCEDURE DIVISION.
001740 M-05.
001750     COPY LIBCPR.
001760     DISPLAY C-CLEAR.
001770     DISPLAY C-MID.
001780 M-07.
001790     ACCEPT A-STC.
001800     IF ESTAT = PF9
001810         GO TO M-95.
001820     IF ESTAT NOT = HTB AND SKP
001830         GO TO M-07.
001840 M-08.
001850     ACCEPT A-ETC.
001860     IF ESTAT = BTB
001870         GO TO M-07.
001880     IF ESTAT NOT = HTB AND SKP
001890         GO TO M-08.
001900     IF W-STC > W-ETC
001910         GO TO M-08.
001920 M-12.
001930     ACCEPT A-DMM.
001940     IF ESTAT = BTB
001950         GO TO M-08.
001960     IF ESTAT NOT = HTB AND SKP
001970         GO TO M-12.
001980     IF W-DMM = 9
001990         GO TO M-07.
002000     IF W-DMM NOT = 1
002010         GO TO M-12.
002020*
002030     CALL "CBLSTNNO" USING STN-NO.
002040     MOVE STN-NO2 TO W-FID2.
002050     MOVE W-FID TO WK0064ID.
002060     OPEN INPUT SNTRF.
002070     OPEN INPUT HI-M.
002080 M-15.
002090     READ SNTRF AT END
002100         CLOSE HI-M
002110         CLOSE SNTRF
002120         DISPLAY C-CLEAR
002130         STOP RUN.
002140     IF SNTR-DC = 4 OR 8
002150         GO TO M-15.
002160     IF SNTR-CSC NOT = 0                                          I.050705
002170         GO TO M-15.                                              I.050705
002180     IF SNTR-TNC < W-STC OR > W-ETC
002190         GO TO M-15.
002200     MOVE SNTR-HCD TO HI-KEY.
002210     READ HI-M WITH UNLOCK INVALID KEY
002220         DISPLAY E-ME2 E-KEY E-ME99
002230         MOVE 0 TO HI-HPV.
002240     IF HI-HPV NOT = 1
002250         GO TO M-15.
002260     PERFORM DST-RTN THRU DST-EX.
002270     IF ZERO = W-SU AND W-UKIN
002280         GO TO M-15.
002290*
002300     OPEN INPUT T-M.
002310     OPEN OUTPUT SP-F.
002320     MOVE DATE-02R TO H-DATE.
002330     MOVE ZERO TO W-PAGE.
002340     PERFORM HED-010 THRU HED-EX.
002350     MOVE ZERO TO WA-D.
002360 M-20.
002370     MOVE ZERO TO WS-D.
002380     MOVE SNTR-TNC1 TO W-TNC1.
002390 M-25.
002400     MOVE 0 TO W-C.
002410     MOVE SNTR-TNC2 TO W-TNC2.
002420 M-30.
002430     MOVE ZERO TO WT-D CHK W-DC.
002440     MOVE SNTR-TCD TO W-TCD.
002450     MOVE SNTR-TCD TO T-KEY.
002460     READ T-M WITH UNLOCK INVALID KEY
002470         MOVE NC"　＊　マスター　なし　＊　　　　　" TO T-NAME.
002480 M-35.
002490     MOVE ZERO TO WN-D.
002500     MOVE SNTR-HCD1 TO W-HCD1.
002510 M-40.
002520     ADD W-SU TO WN-SU.
002530     ADD W-UKIN TO WN-UKI.
002540 M-45.
002550     READ SNTRF AT END
002560         GO TO M-80.
002570     IF SNTR-DC = 4 OR 8
002580         GO TO M-45.
002590     IF SNTR-CSC NOT = 0                                          I.050705
002600         GO TO M-45.                                              I.050705
002610     IF SNTR-TNC < W-STC OR > W-ETC
002620         GO TO M-45.
002630     MOVE SNTR-HCD TO HI-KEY.
002640     READ HI-M WITH UNLOCK INVALID KEY
002650         DISPLAY E-ME2 E-KEY E-ME99
002660         MOVE 0 TO HI-HPV.
002670     IF HI-HPV NOT = 1
002680         GO TO M-45.
002690     PERFORM DST-RTN THRU DST-EX.
002700     IF ZERO = W-SU AND W-UKIN
002710         GO TO M-45.
002720*
002730     IF W-TNC NOT = SNTR-TNC
002740         GO TO M-60.
002750     IF W-TCD NOT = SNTR-TCD
002760         GO TO M-55.
002770     IF W-HCD1 NOT = SNTR-HCD1
002780         GO TO M-50.
002790     GO TO M-40.
002800 M-50.
002810     PERFORM MPR-RTN THRU MPR-EX.
002820     GO TO M-35.
002830 M-55.
002840     PERFORM MPR-RTN THRU MPR-EX.
002850     PERFORM KPR-RTN THRU KPR-EX.
002860     GO TO M-30.
002870 M-60.
002880     PERFORM MPR-RTN THRU MPR-EX.
002890     PERFORM KPR-RTN THRU KPR-EX.
002900     IF W-TNC1 = SNTR-TNC1
002910         GO TO M-25.
002920     PERFORM SPR-RTN THRU SPR-EX.
002930     GO TO M-20.
002940 M-80.
002950     PERFORM MPR-RTN THRU MPR-EX.
002960     PERFORM KPR-RTN THRU KPR-EX.
002970     PERFORM SPR-RTN THRU SPR-EX.
002980*
002990     MOVE SPACE TO W-P.
003000     MOVE SPACE TO P-TNA P-HNA.
003010     MOVE NC"　【　　総　合　計　　】　　　　" TO P-HNA.
003020     MOVE WA-SU TO P-SU.
003030     MOVE WA-UKI TO P-KIN.
003040*****IF LINAGE-COUNTER > 60                                       D.070205
003050     IF LINAGE-COUNTER > 62                                       I.070205
003060         PERFORM HED-RTN THRU HED-EX.
003070     MOVE SPACE TO SP-R.
003080     MOVE W-P TO SP-R.
003090     WRITE SP-R.
003100*
003110     CLOSE SNTRF.
003120     CLOSE SP-F.
003130     CLOSE T-M.
003140     CLOSE HI-M.
003150 M-95.
003160     DISPLAY C-CLEAR.
003170     STOP RUN.
003180 DST-RTN.
003190     MOVE ZERO TO W-RD.
003200     IF (SNTR-SNC = 1) OR (SNTR-DC = 1 OR 2 OR 5)
003210         COMPUTE W-SU = SNTR-SU * -1
003220         COMPUTE W-UKIN = SNTR-KIN * -1
003230       ELSE
003240         MOVE SNTR-SU TO W-SU
003250         MOVE SNTR-KIN TO W-UKIN.
003260     IF (SNTR-HCD > 999899) OR (SNTR-SNC = 1) OR (SNTR-DC = 2)
003270         MOVE ZERO TO W-SU.
003280 DST-EX.
003290     EXIT.
003300 HED-RTN.
003310     MOVE SPACE TO SP-R.
003320     WRITE SP-R AFTER PAGE.
003330 HED-010.
003340     ADD 1 TO W-PAGE.
003350     MOVE W-PAGE TO H-PAGE.
003360     MOVE SPACE TO SP-R.
003370     MOVE HEAD1 TO SP-R.
003380     WRITE SP-R.
003390     MOVE SPACE TO SP-R.
003400     MOVE HEAD2 TO SP-R.
003410     WRITE SP-R AFTER 2.
003420     MOVE SPACE TO SP-R.
003430 HED-EX.
003440     EXIT.
003450 MPR-RTN.
003460     IF ZERO = WN-SU AND WN-UKI
003470         GO TO MPR-EX.
003480     PERFORM HNA-RTN THRU HNA-EX.
003490*
003500     MOVE SPACE TO W-P.
003510     MOVE SPACE TO P-TNA P-HNA.
003520     IF W-C = ZERO
003530         MOVE 5 TO W-C
003540         MOVE 0 TO CHK
003550         MOVE W-TNC TO P-TNC.
003560     IF CHK = ZERO
003570         MOVE 5 TO CHK
003580         MOVE W-TCD TO P-TCD
003590         MOVE T-NAME TO P-TNA.
003600     MOVE W-HCD1 TO P-HCD1.
003610     MOVE W-NAME TO P-HNA.
003620     MOVE WN-SU TO P-SU.
003630     MOVE WN-UKI TO P-KIN.
003640     MOVE ZERO TO W-UT.
003650     IF WN-SU = ZERO
003660         GO TO MPR-020.
003670     IF WN-UKI NOT = ZERO
003680         COMPUTE W-UT ROUNDED = WN-UKI / WN-SU.
003690     MOVE W-UT TO P-UT.
003700 MPR-020.
003710*****IF LINAGE-COUNTER > 60                                       D.070205
003720     IF LINAGE-COUNTER > 62                                       I.070205
003730         MOVE W-TNC TO P-TNC
003740         MOVE W-TCD TO P-TCD
003750         MOVE T-NAME TO P-TNA
003760         PERFORM HED-RTN THRU HED-EX.
003770     MOVE SPACE TO SP-R.
003780     WRITE SP-R FROM W-P AFTER 1.
003790     MOVE SPACE TO SP-R.
003800*
003810     ADD WN-SU TO WT-SU.
003820     ADD WN-UKI TO WT-UKI.
003830     ADD 1 TO W-DC.
003840 MPR-EX.
003850     EXIT.
003860 HNA-RTN.
003870     MOVE SPACE TO W-NAME W-HNA.
003880     MOVE SPACE TO HI-KEY.
003890     MOVE W-HCD1 TO HI-HCD1.
003900     START HI-M KEY NOT < HI-KEY INVALID KEY
003910         MOVE NC"　＊＊　マスター　なし　＊＊" TO W-NAME
003920         GO TO HNA-EX.
003930     READ HI-M NEXT RECORD WITH UNLOCK AT END
003940         MOVE NC"　＊＊　マスター　なし　＊＊" TO W-NAME
003950         GO TO HNA-EX.
003960     IF W-HCD1 NOT = HI-HCD1
003970         MOVE NC"　＊＊　マスター　なし　＊＊" TO W-NAME
003980         GO TO HNA-EX.
003990     MOVE HI-NAME TO W-HNA.
004000     MOVE ZERO TO CNT.
004010 HNA-020.
004020     ADD 1 TO CNT.
004030     IF CNT > 24
004040         GO TO HNA-EX.
004050     MOVE W-HNAD(CNT) TO W-NA(CNT).
004060     IF W-HNAD(CNT) NOT = SPACE
004070         GO TO HNA-020.
004080     ADD 1 TO CNT.
004090     IF CNT > 24
004100         GO TO HNA-EX.
004110     MOVE W-HNAD(CNT) TO W-NA(CNT).
004120     IF W-HNAD(CNT) NOT = SPACE
004130         GO TO HNA-020.
004140 HNA-EX.
004150     EXIT.
004160 KPR-RTN.
004170     IF ZERO = WT-SU AND WT-UKI
004180         GO TO KPR-EX.
004190     IF W-DC < 2
004200         GO TO KPR-040.
004210     MOVE SPACE TO W-P.
004220     MOVE SPACE TO P-TNA P-HNA.
004230     MOVE NC"　　　　　　　　　　　（　小　計　）　" TO P-HNA.
004240     MOVE WT-SU TO P-SU.
004250     MOVE WT-UKI TO P-KIN.
004260 KPR-020.
004270*****IF LINAGE-COUNTER > 60                                       D.070205
004280     IF LINAGE-COUNTER > 62                                       I.070205
004290         MOVE W-TNC TO P-TNC
004300         PERFORM HED-RTN THRU HED-EX.
004310     MOVE SPACE TO SP-R.
004320     WRITE SP-R FROM W-P AFTER 1.
004330     MOVE SPACE TO SP-R.
004340 KPR-040.
004350     ADD WT-SU TO WS-SU.
004360     ADD WT-UKI TO WS-UKI.
004370 KPR-EX.
004380     EXIT.
004390 SPR-RTN.
004400     IF ZERO = WS-SU AND WS-UKI
004410         MOVE SPACE TO SP-R
004420         WRITE SP-R
004430         GO TO SPR-EX.
004440*
004450     MOVE SPACE TO W-P.
004460     MOVE SPACE TO P-TNA P-HNA.
004470     MOVE NC"　　　　［　　合　計　　］　　　　　" TO P-HNA.
004480     MOVE WS-SU TO P-SU.
004490     MOVE WS-UKI TO P-KIN.
004500*****IF LINAGE-COUNTER > 60                                       D.070205
004510     IF LINAGE-COUNTER > 62                                       I.070205
004520         PERFORM HED-RTN THRU HED-EX.
004530     MOVE SPACE TO SP-R.
004540     WRITE SP-R FROM W-P AFTER 1.
004550     MOVE SPACE TO SP-R.
004560     WRITE SP-R.
004570*
004580     ADD WS-SU TO WA-SU.
004590     ADD WS-UKI TO WA-UKI.
004600 SPR-EX.
004610     EXIT.

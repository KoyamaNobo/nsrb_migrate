000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. HKY510.
000030*******************************************************
000040*****     履物・工品　売上消費税ワーク　作成     ******
000050*****       JS-SIGN   0:STRANYR  1:URIRYR    　　******
000060*******************************************************
000070 ENVIRONMENT DIVISION.
000080 CONFIGURATION SECTION.
000090 SOURCE-COMPUTER. SYSTEM3100.
000100 OBJECT-COMPUTER. SYSTEM3100.
000110 INPUT-OUTPUT SECTION.
000120 FILE-CONTROL.
000130     COPY LIBCSE.
000140     SELECT T-M ASSIGN TO T1-MSD T2-MSD
000150         ORGANIZATION INDEXED
000160         ACCESS MODE RANDOM
000170         RECORD KEY T-KEY
000180         ALTERNATE RECORD KEY T-KEY2
000190         FILE STATUS ERR-STAT.
000200     SELECT STRAN ASSIGN TO STRN-MSD.
000210     SELECT URIRYR ASSIGN TO URIRYR-MSD.
000220     SELECT URIAGE ASSIGN TO URI-MSD.
000230 I-O-CONTROL.
000240     APPLY SHARED-MODE ON M-DATE
000250     APPLY SHARED-MODE ON T-M.
000260 DATA DIVISION.
000270 FILE SECTION.
000280     COPY LIBFDD.
000290     COPY LITM.
000300 FD  STRAN
000310     BLOCK  2 RECORDS
000320     LABEL RECORD IS STANDARD
000330     VALUE OF IDENTIFICATION IS "STRANYR".
000340 01  STRAN-R.
000350     02  ST-DNO         PIC  9(006).
000360     02  ST-GNO         PIC  9(001).
000370     02  ST-DATE        PIC  9(008).
000380     02  ST-DATED REDEFINES ST-DATE.
000390       03  ST-NG        PIC  9(006).
000400       03  F            PIC  9(002).
000410     02  ST-TCD         PIC  9(004).
000420     02  ST-D1.
000430       03  ST-HCD       PIC  9(006).
000440       03  F            PIC  X(031).
000450       03  ST-SU        PIC S9(005).
000460       03  ST-T         PIC S9(005).
000470       03  ST-KIN       PIC S9(008).
000480       03  ST-CSC       PIC  9(001).
000490       03  ST-DC        PIC  9(001).
000500       03  ST-FT        PIC  9(005).
000510       03  ST-CCD       PIC  9(003).
000520       03  F            PIC  X(007).
000530       03  ST-TNC       PIC  9(002).
000540       03  F            PIC  X(002).
000550       03  ST-ZC        PIC  9(001).
000560       03  F            PIC  X(031).
000570     02  ST-D2    REDEFINES ST-D1.
000580       03  ST-BI        PIC  N(024).
000590       03  ST-HNO       PIC  9(006).
000600       03  F            PIC  X(030).
000610       03  ST-SHZ       PIC S9(007).
000620       03  F            PIC  X(017).
000630     02  ST-SNC         PIC  9(001).
000640 FD  URIRYR
000650     BLOCK  2 RECORDS
000660     LABEL RECORD IS STANDARD
000670     VALUE OF IDENTIFICATION IS "URIRYR".
000680 01  URIRY-R.
000690     02  URIRY-DC       PIC  9(001).
000700     02  URIRY-NG       PIC  9(006).
000710     02  F              PIC  X(002).
000720     02  URIRY-TCD      PIC  9(004).
000730     02  URIRY-HCD      PIC  X(005).
000740     02  F              PIC  X(016).
000750     02  URIRY-KIN      PIC S9(008).
000760     02  F              PIC  X(013).
000770     02  URIRY-CSC      PIC  9(001).
000780     02  F              PIC  X(010).
000790     02  URIRY-DNO      PIC  9(006).
000800     02  F              PIC  X(054).
000810     02  URIRY-ZC       PIC  9(001).
000820     02  F              PIC  X(001).
000830 FD  URIAGE
000840     BLOCK  2 RECORDS
000850     LABEL RECORD IS STANDARD
000860     VALUE OF IDENTIFICATION IS WK0128ID.
000870 01  URIAGE-R.
000880     02  UR-NG          PIC  9(006).
000890     02  UR-BMC         PIC  9(002).
000900     02  UR-TCD         PIC  9(004).
000910     02  UR-NAME        PIC  N(026).
000920     02  UR-KIN0        PIC S9(010).
000930     02  UR-KIN5        PIC S9(010).
000940     02  UR-KIN8        PIC S9(010).
000950     02  UR-SHZ5        PIC S9(009).
000960     02  UR-SHZ8        PIC S9(009).
000970     02  UR-TNC         PIC  9(002).
000980     02  F              PIC  X(014).
000990 WORKING-STORAGE SECTION.
001000 77  JS-SIGN            PIC  9(001).
001010 77  W-FILE             PIC  X(013).                              I.940627
001020 77  W-END              PIC  9(001) VALUE 0.                      I.970108
001030 77  WK0128ID           PIC  X(009) VALUE SPACE.                  I.001127
001040 01  STN-NO.                                                      I.950612
001050     02  STN-NO1        PIC  X(003).                              I.950612
001060     02  STN-NO2        PIC  X(003).                              I.950612
001070 01  W-FID.                                                       I.950612
001080     02  W-FID1         PIC  X(006) VALUE "WK0128".               I.001127
001090     02  W-FID2         PIC  X(003).                              I.950612
001100 01  W-DATA.
001110     02  W-SNG.
001120       03  W-SNEN       PIC  9(004).
001130       03  W-SNENL REDEFINES W-SNEN.
001140         04  W-SNEN1    PIC  9(002).
001150         04  W-SNEN2    PIC  9(002).
001160       03  W-SGET       PIC  9(002).
001170     02  W-SNGL  REDEFINES W-SNG.
001180       03  F            PIC  9(002).
001190       03  W-SNGS       PIC  9(004).
001200     02  W-ENG.
001210       03  W-ENEN       PIC  9(004).
001220       03  W-ENENL REDEFINES W-ENEN.
001230         04  W-ENEN1    PIC  9(002).
001240         04  W-ENEN2    PIC  9(002).
001250       03  W-EGET       PIC  9(002).
001260     02  W-ENGL  REDEFINES W-ENG.
001270       03  F            PIC  9(002).
001280       03  W-ENGS       PIC  9(004).
001290     02  W-DMM          PIC  9(001).
001300     02  W-TD.
001310       03  W-KIN        PIC S9(010).
001320       03  W-SHZ        PIC S9(009).
001330     02  W-DNO          PIC  9(006).
001340     02  W-TCD          PIC  9(004).
001350     02  W-NG           PIC  9(006).
001360     02  W-DC           PIC  9(001).
001370     02  W-ZC           PIC  9(001).
001380 01  ERR-STAT           PIC  X(002).
001390     COPY LSTAT.
001400 SCREEN SECTION.
001410 SD  C-CRT
001420     END STATUS IS ESTAT.
001430 01  C-CLEAR.
001440     02  C-CL    LINE   1  CLEAR SCREEN.
001450 01  C-MID.
001460     02  LINE   3  COLUMN  10  PIC  N(022) VALUE
001470          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001480     02  LINE   4  COLUMN  10  PIC  N(022) VALUE
001490          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001500     02  LINE   5  COLUMN  10  PIC  N(022) VALUE
001510          NC"＊＊＊　　　　　　　　　　　　　　　　＊＊＊".
001520     02  LINE   6  COLUMN  10  PIC  N(022) VALUE
001530          NC"＊＊＊　　売上・消費税ワーク　作成　　＊＊＊".
001540     02  LINE   7  COLUMN  10  PIC  N(022) VALUE
001550          NC"＊＊＊　　　　　　　　　　　　　　　　＊＊＊".
001560     02  LINE   8  COLUMN  10  PIC  N(022) VALUE
001570          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001580     02  LINE   9  COLUMN  10  PIC  N(022) VALUE
001590          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001600     02  LINE  12  COLUMN  14  PIC  X(036) VALUE
001610          "抽出期間    '  年   月 〜 '  年   月".
001620     02  LINE  20  COLUMN  22  PIC  X(022) VALUE
001630          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001640 01  C-MID1.
001650     02  LINE   5  COLUMN  25  PIC  N(007) VALUE
001660          NC"（　履　物　）".
001670 01  C-MID2.
001680     02  LINE   5  COLUMN  25  PIC  N(007) VALUE
001690          NC"（　工　品　）".
001700 01  C-ACP.
001710     02  A-PNG    LINE  12.
001720       03  A-SNEN  COLUMN  27  PIC  9(002)
001730            USING W-SNEN2 CHECK OVERFLOW NO IFC.
001740       03  A-SGET  COLUMN  32  PIC  9(002)
001750            USING W-SGET  CHECK OVERFLOW NO IFC.
001760       03  A-ENEN  COLUMN  41  PIC  9(002)
001770            USING W-ENEN2 CHECK OVERFLOW NO IFC.
001780       03  A-EGET  COLUMN  46  PIC  9(002)
001790            USING W-EGET  CHECK OVERFLOW NO IFC.
001800     02  A-DMM   LINE  20  COLUMN  39  PIC  9(001)
001810          USING W-DMM   CHECK OVERFLOW NO IFC.
001820 01  C-ERR.
001830     02  LINE 24.
001840       03  E-ME31.
001850         04  COLUMN  15  PIC  X(039) VALUE
001860              "***  ﾃﾞﾝﾋﾟｮｳNO ｴﾗｰ (      ･      )  ***".
001870         04  COLUMN  35  PIC  9(006) FROM  ST-DNO.
001880         04  COLUMN  42  PIC  9(006) FROM  W-DNO.
001890       03  E-ME32.
001900         04  COLUMN  15  PIC  X(037) VALUE
001910              "***  ｾﾞｲｸﾌﾞﾝ ｴﾗｰ (      ･      )  ***".
001920         04  COLUMN  33  PIC  9(006) FROM  ST-DNO.
001930         04  COLUMN  40  PIC  9(006) FROM  W-DNO.
001940       03  E-TCD   COLUMN  57  PIC  9(004) FROM  ST-TCD.
001950     COPY LSSEM.
001960     COPY LIBSCR.
001970 PROCEDURE DIVISION.
001980 M-05.
001990     ACCEPT JS-SIGN.
002000     IF JS-SIGN > 1
002010         STOP RUN.
002020     DISPLAY C-CLEAR.
002030     DISPLAY C-MID.
002040     IF JS-SIGN = 0
002050         DISPLAY C-MID1
002060       ELSE
002070         IF JS-SIGN = 1
002080             DISPLAY C-MID2.
002090     MOVE ZERO TO W-DATA.
002100     COPY LIBCPR.
002110     PERFORM S-10 THRU S-35.
002120     IF ESTAT = PF9
002130         DISPLAY C-CLEAR
002140         STOP RUN.
002150*
002160     CALL "CBLSTNNO" USING STN-NO.
002170     MOVE STN-NO2 TO W-FID2.
002180     MOVE W-FID TO WK0128ID.
002190     OPEN INPUT T-M.
002200     OPEN OUTPUT URIAGE.
002210     IF JS-SIGN = 1
002220         GO TO M-50.
002230     OPEN INPUT STRAN.
002240 M-10.
002250     READ STRAN AT END
002260         GO TO M-90.
002270     IF ST-NG < W-SNG
002280         GO TO M-10.
002290     IF ST-NG > W-ENG
002300         GO TO M-90.
002310     IF ST-GNO = 9
002320         DISPLAY E-ME31 E-TCD E-ME99
002330         GO TO M-85.
002340 M-15.
002350     MOVE ZERO TO W-TD.
002360     MOVE ST-DNO TO W-DNO.
002370     MOVE ST-ZC TO W-ZC.
002380     MOVE ST-DC TO W-DC.
002390 M-20.
002400     IF ST-SNC = 1
002410         SUBTRACT ST-KIN FROM W-KIN
002420       ELSE
002430         IF ST-DC = 0 OR 3 OR 7
002440             ADD ST-KIN TO W-KIN
002450           ELSE
002460             IF ST-DC = 1 OR 2 OR 5
002470                 SUBTRACT ST-KIN FROM W-KIN.
002480 M-25.
002490     READ STRAN AT END
002500         DISPLAY E-ME31 E-TCD E-ME99
002510         GO TO M-85.
002520     IF ST-NG < W-SNG
002530         GO TO M-25.
002540     IF ST-NG > W-ENG
002550         GO TO M-90.
002560     IF ST-GNO = 9
002570         GO TO M-30.
002580     IF ST-DNO NOT = W-DNO
002590         DISPLAY E-ME31 E-TCD E-ME99
002600         GO TO M-85.
002610     GO TO M-20.
002620 M-30.
002630     IF ST-DNO NOT = W-DNO
002640         DISPLAY E-ME31 E-TCD E-ME99
002650         GO TO M-85.
002660     IF ZERO = ST-SHZ AND W-KIN
002670         GO TO M-10.
002680     IF ST-SNC = 0
002690         IF W-ZC NOT = 0
002700             IF ST-SHZ = ZERO
002710                 DISPLAY E-ME32 E-TCD E-ME99
002720                 GO TO M-85.
002730     IF ST-SNC = 0
002740         IF W-ZC = 0
002750             IF ST-SHZ NOT = ZERO
002760                 DISPLAY E-ME32 E-TCD E-ME99
002770                 GO TO M-85.
002780*
002790     IF ST-SNC = 1
002800         SUBTRACT ST-SHZ FROM W-SHZ
002810       ELSE
002820         ADD ST-SHZ TO W-SHZ.
002830*
002840     MOVE ST-TCD TO T-KEY.
002850     READ T-M WITH UNLOCK INVALID KEY
002860         MOVE ZERO TO T-BC T-DCC.
002870*
002880     MOVE ZERO TO URIAGE-R.
002890     MOVE ST-NG TO UR-NG.
002900     MOVE T-BC TO UR-BMC.
002910     MOVE ST-TCD TO UR-TCD.
002920     MOVE T-NAME TO UR-NAME.
002930     IF W-ZC = 0
002940         MOVE W-KIN TO UR-KIN0
002950       ELSE
002960         IF W-ZC = 5
002970             MOVE W-KIN TO UR-KIN5
002980             MOVE W-SHZ TO UR-SHZ5
002990           ELSE
003000             IF W-ZC = 8
003010                 MOVE W-KIN TO UR-KIN8
003020                 MOVE W-SHZ TO UR-SHZ8.
003030     MOVE T-TNC TO UR-TNC.
003040     WRITE URIAGE-R.
003050     GO TO M-10.
003060*-------------------------------------------------------------------------
003070 M-50.
003080     OPEN INPUT URIRYR.
003090 M-55.
003100     READ URIRYR AT END
003110         GO TO M-90.
003120     IF URIRY-NG < W-SNG
003130         GO TO M-55.
003140     IF URIRY-NG > W-ENG
003150         GO TO M-90.
003160     IF URIRY-DC = 4
003170         GO TO M-55.
003180 M-60.
003190     MOVE ZERO TO W-TD.
003200     MOVE URIRY-DNO TO W-DNO.
003210     MOVE URIRY-TCD TO W-TCD.
003220     MOVE URIRY-ZC TO W-ZC.
003230     MOVE URIRY-NG TO W-NG.
003240 M-65.
003250     IF URIRY-DC = 9
003260         SUBTRACT URIRY-KIN FROM W-SHZ
003270       ELSE
003250         IF URIRY-DC = 8
003260             SUBTRACT URIRY-KIN FROM W-KIN
003270           ELSE
003250             IF URIRY-DC = 5
003260                 ADD URIRY-KIN TO W-SHZ
003270               ELSE
003280                 ADD URIRY-KIN TO W-KIN.
003290 M-70.
003300     READ URIRYR AT END
003310         MOVE 1 TO W-END
003320         GO TO M-75.
003330     IF URIRY-NG < W-SNG
003340         GO TO M-70.
003350     IF URIRY-NG > W-ENG
003360         MOVE 1 TO W-END
003370         GO TO M-75.
003380     IF URIRY-DC = 4
003390         GO TO M-70.
003400     IF URIRY-DNO = W-DNO
003410         IF URIRY-TCD = W-TCD
003420             IF URIRY-NG = W-NG
003430                 GO TO M-65.
003440 M-75.
003450     MOVE W-TCD TO T-KEY.                                         I.000831
003460     READ T-M WITH UNLOCK INVALID KEY                             I.000831
003470         MOVE ZERO TO T-BC T-DCC.                                 I.010221
003480*
003490     MOVE ZERO TO URIAGE-R.
003500     MOVE W-NG TO UR-NG.
003510     MOVE T-BC TO UR-BMC.
003520     MOVE W-TCD TO UR-TCD.
003530     MOVE T-NAME TO UR-NAME.
003540     IF W-ZC = 0
003550         MOVE W-KIN TO UR-KIN0
003560       ELSE
003570         IF W-ZC = 5
003580             MOVE W-KIN TO UR-KIN5
003590             MOVE W-SHZ TO UR-SHZ5
003600           ELSE
003610             IF W-ZC = 8
003620                 MOVE W-KIN TO UR-KIN8
003630                 MOVE W-SHZ TO UR-SHZ8.
003640     MOVE T-TNC TO UR-TNC.
003650     WRITE URIAGE-R.
003660     IF W-END = 0
003670         GO TO M-60.
003680 M-85.
003690     MOVE 255 TO COMPLETION-CODE.
003700 M-90.
003710     IF JS-SIGN = 0
003720         CLOSE STRAN
003730       ELSE
003740         IF JS-SIGN = 1
003750             CLOSE URIRYR.
003760     CLOSE T-M.
003770     CLOSE URIAGE.
003780 M-980.
003790     DISPLAY C-CLEAR.
003800     STOP RUN.
003810 S-10.
003820     ACCEPT A-SNEN.
003830     IF ESTAT = PF9
003840         GO TO S-35.
003850     IF ESTAT NOT = HTB AND SKP
003860         GO TO S-10.
003870     MOVE ZERO TO W-SNEN1.
003880     IF W-SNEN2 >= DATE-NF1 AND <= DATE-NT1
003890         ADD DATE-NC1 TO W-SNEN.
003900     IF W-SNEN2 >= DATE-NF2 AND <= DATE-NT2
003910         ADD DATE-NC2 TO W-SNEN.
003920     IF W-SNEN < 2014
003930         GO TO S-10.
003940 S-15.
003950     ACCEPT A-SGET.
003960     IF ESTAT = BTB
003970         GO TO S-10.
003980     IF ESTAT NOT = HTB AND SKP
003990         GO TO S-15.
004000     IF W-SGET < 1 OR > 12
004010         GO TO S-15.
004020 S-20.
004030     ACCEPT A-ENEN.
004040     IF ESTAT = BTB
004050         GO TO S-15.
004060     IF ESTAT NOT = HTB AND SKP
004070         GO TO S-20.
004080     MOVE ZERO TO W-ENEN1.
004090     IF W-ENEN2 >= DATE-NF1 AND <= DATE-NT1
004100         ADD DATE-NC1 TO W-ENEN.
004110     IF W-ENEN2 >= DATE-NF2 AND <= DATE-NT2
004120         ADD DATE-NC2 TO W-ENEN.
004130     IF W-ENEN < W-SNEN
004140         GO TO S-20.
004150 S-25.
004160     ACCEPT A-EGET.
004170     IF ESTAT = BTB
004180         GO TO S-20.
004190     IF ESTAT NOT = HTB AND SKP
004200         GO TO S-25.
004210     IF W-ENG < W-SNG
004220         GO TO S-25.
004230     IF W-EGET < 1 OR > 12
004240         GO TO S-25.
004250 S-30.
004260     ACCEPT A-DMM.
004270     IF ESTAT = BTB
004280         GO TO S-25.
004290     IF ESTAT NOT = HTB AND SKP
004300         GO TO S-30.
004310     IF W-DMM = 9
004320         GO TO S-10.
004330     IF W-DMM NOT = 1
004340         GO TO S-30.
004350 S-35.
004360     EXIT.

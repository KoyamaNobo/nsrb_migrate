000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. HKG850.
000030*******************************************************************
000040*    PROGRAM         :  請求書　取り消し                          *
000050*    PRINTER TYPE    :  JIPS                                      *
000060*    SCREEN          :  ******                                    *
000070*******************************************************************
000080 ENVIRONMENT DIVISION.
000090 CONFIGURATION SECTION.
000100 SOURCE-COMPUTER. SYSTEM3100.
000110 OBJECT-COMPUTER. SYSTEM3100.
000120 INPUT-OUTPUT SECTION.
000130 FILE-CONTROL.
000140     SELECT TSKF ASSIGN TO TSK-MSD
000150         ORGANIZATION IS INDEXED
000160         ACCESS MODE IS DYNAMIC
000170         RECORD KEY IS TSK-KEY
000180         FILE STATUS IS ERR-STAT.
000190     SELECT SKDF ASSIGN TO SKD-MSD
000200         ORGANIZATION IS INDEXED
000210         ACCESS MODE IS DYNAMIC
000220         RECORD KEY IS SKD-KEY
000230         FILE STATUS IS ERR-STAT.
000240     SELECT T-M ASSIGN TO T1-MSD T2-MSD
000250         ORGANIZATION IS INDEXED
000260         ACCESS MODE IS RANDOM
000270         RECORD KEY IS T-KEY
000280         ALTERNATE RECORD KEY IS T-KEY2
000290         FILE STATUS IS ERR-STAT.
000300*****SELECT TUKF ASSIGN TO TUK-MSD                                D.030916
000310     SELECT TUKF ASSIGN TO TUK1-MSD TUK2-MSD                      I.030916
000320         ORGANIZATION IS INDEXED
000330         ACCESS MODE IS DYNAMIC
000340         RECORD KEY IS TUK-KEY
000350         ALTERNATE RECORD KEY IS TUK-KEY2                         I.030916
000360         FILE STATUS IS ERR-STAT.
000370     SELECT SM-F ASSIGN TO SM-MSD.
000380 I-O-CONTROL.
000390     APPLY SHARED-MODE ON T-M
000400     APPLY SHARED-MODE ON TUKF
000410     APPLY SHARED-MODE ON TSKF
000420     APPLY SHARED-MODE ON SKDF.
000430 DATA DIVISION.
000440 FILE SECTION.
000450     COPY LITSKF.
000460     COPY LISKDF.
000470     COPY LITM.
000480     COPY LITUKF.
000490 FD  SM-F
000500     BLOCK  5 RECORDS
000510     LABEL RECORD IS STANDARD
000520     VALUE OF IDENTIFICATION "SMF".
000530 01  SM-R.
000540     02  SM-TCD         PIC  X(004).
000550     02  SM-DATE        PIC  9(008).
000560     02  SM-SZZ         PIC S9(009).
000570     02  SM-SZZZ        PIC S9(007).
000580     02  SM-SUK         PIC S9(009).
000590     02  SM-SUKZ        PIC S9(007).
000600     02  SM-STS         PIC S9(007).
000610     02  SM-STSZ        PIC S9(005).
000620     02  SM-SNK         PIC S9(009).
000630     02  SM-SNKZ        PIC S9(007).
000640     02  F              PIC  X(010).
000650     02  SM-DNO         PIC  9(006).
000660     02  SM-SP          PIC  9(002).
000670     02  SM-SK          PIC  9(001).
000680     02  SM-CHK         PIC  9(001).
000690     02  F              PIC  X(006).
000700     02  SM-CCD         PIC  9(003).
000710     02  SM-PC          PIC  9(001).
000720 WORKING-STORAGE SECTION.
000730 77  W-END              PIC  9(001) VALUE 0.
000740 01  W-DATA.
000750     02  W-SEN          PIC  9(001).
000760     02  W-DATE.
000770       03  W-NEN        PIC  9(004).
000780       03  W-GET        PIC  9(002).
000790       03  W-PEY        PIC  9(002).
000800     02  W-TCD          PIC  9(004).
000810     02  W-DMM          PIC  9(001).
000820     02  W-DC           PIC  9(001).
000830 01  ERR-STAT           PIC  X(002).
000840     COPY LSTAT.
000850 SCREEN SECTION.
000860 SD  C-CRT
000870     END STATUS IS ESTAT.
000880 01  C-CLEAR.
000890     02  C-CL    LINE   1  CLEAR SCREEN.
000900 01  C-MID.
000910     02  LINE   1  COLUMN  22  PIC  N(018) VALUE
000920          NC"＊＊＊　　請求書　取り消し　　＊＊＊".
000930     02  LINE   4  COLUMN  23  PIC  X(042) VALUE
000940            "一括 = 1  ,  得意先別 = 2  .....  ".
000950     02  LINE  10  COLUMN  30  PIC  X(019) VALUE
000960          "    年   月   日 分".
000970     02  LINE  22  COLUMN  29  PIC  X(022) VALUE
000980          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
000990 01  C-ACP.
001000     02  A-SEN   LINE   4  COLUMN  56  PIC  9(001)
001010          USING W-SEN   CHECK OVERFLOW NO IFC.
001020     02  A-TCD   LINE   7  COLUMN  11  PIC  9(004)
001030          USING W-TCD   CHECK OVERFLOW NO IFC.
001040     02  A-DMM   LINE  22  COLUMN  46  PIC  9(001)
001050          USING W-DMM   CHECK OVERFLOW NO IFC.
001060 01  C-DSP.
001070     02  D-MID1.
001080       03  LINE   7.
001090         04  COLUMN   6  PIC  X(011) VALUE "ｺｰﾄﾞ       ".
001100         04  COLUMN  17  PIC  N(004) VALUE NC"得意先名".
001110         04  COLUMN  26  PIC  X(052) VALUE                        I.020409
001120          "                                                    ". I.020409
001130*****    04  COLUMN  26  PIC  X(048) VALUE                        D.020409
001140*****         "                                                ". D.020409
001150       03  LINE   8  COLUMN  11  PIC  X(009) VALUE "終了=ｆ･9".
001160       03  LINE  10  COLUMN  30  PIC  X(019) VALUE
001170            "    年   月   日 分".
001180*****02  D-TNA   LINE   7  COLUMN  26  PIC  N(024) FROM  T-NAME.  D.020409
001190     02  D-TNA   LINE   7  COLUMN  26  PIC  N(026) FROM  T-NAME.  I.020409
001200     02  D-DATE  LINE  10.
001210       03  COLUMN  30  PIC  9(004) FROM  W-NEN.
001220       03  COLUMN  37  PIC  9(002) FROM  W-GET.
001230       03  COLUMN  42  PIC  9(002) FROM  W-PEY.
001240 01  C-ERR.
001250     02  LINE  24.
001260       03  E-STAT  COLUMN  10  PIC  X(002) FROM  ERR-STAT.
001270       03  E-ME1   COLUMN  15  PIC  X(017) VALUE
001280            "***  DATA ﾅｼ  ***".
001290       03  E-ME2   COLUMN  15  PIC  X(026) VALUE
001300            "***  TSKF REWRITE ｴﾗｰ  ***".
001310       03  E-ME3   COLUMN  15  PIC  X(026) VALUE
001320            "***  SKDF REWRITE ｴﾗｰ  ***".
001330       03  E-ME4   COLUMN  15  PIC  X(016) VALUE
001340            "***  SMF ﾅｼ  ***".
001350       03  E-ME5   COLUMN  15  PIC  X(017) VALUE
001360            "***  TUKF ﾅｼ  ***".
001370       03  E-ME6   COLUMN  15  PIC  X(025) VALUE
001380            "***  TUKF DELETE ｴﾗｰ  ***".
001390       03  E-ME7   COLUMN  15  PIC  X(026) VALUE
001400            "***  TUKF REWRITE ｴﾗｰ  ***".
001410       03  E-SKD   COLUMN  45  PIC  X(020) FROM  SKD-KEY.
001420       03  E-TSK   COLUMN  45  PIC  9(004) FROM  TSK-KEY.
001430       03  E-TUK   COLUMN  45  PIC  X(014) FROM  TUK-KEY.
001440       03  E-ME98  COLUMN  75  PIC  X(005) VALUE ""27"J"05"".
001450       03  E-ME99  COLUMN  75  PIC  X(005) VALUE ""27"B"05"".
001460       03  E-CL.
001470         04  COLUMN   1  PIC  X(040) VALUE
001480              "                                        ".
001490         04  COLUMN  41  PIC  X(040) VALUE
001500              "                                        ".
001510 PROCEDURE DIVISION.
001520 M-05.
001530     DISPLAY C-CLEAR.
001540     DISPLAY C-MID.
001550     MOVE ZERO TO W-DATA.
001560 M-10.
001570     ACCEPT A-SEN.
001580     IF ESTAT = PF9
001590         MOVE 255 TO COMPLETION-CODE
001600         GO TO M-95.
001610     IF ESTAT NOT = HTB AND SKP
001620         GO TO M-10.
001630     IF W-SEN < 1 OR > 2
001640         GO TO M-10.
001650 M-15.
001660     ACCEPT A-DMM.
001670     IF ESTAT = BTB
001680         GO TO M-10.
001690     IF ESTAT NOT = HTB AND SKP
001700         GO TO M-15.
001710     IF W-DMM = 9
001720         GO TO M-10.
001730     IF W-DMM NOT = 1
001740         GO TO M-15.
001750*
001760     IF W-SEN = 1
001770         PERFORM IKS-RTN THRU IKS-EX
001780       ELSE
001790         PERFORM TBS-RTN THRU TBS-EX.
001800 M-95.
001810     DISPLAY C-CLEAR.
001820     STOP RUN.
001830*=========================================================================
001840 IKS-RTN.
001850     OPEN INPUT TSKF.
001860 IKS-020.
001870     READ TSKF NEXT RECORD AT END
001880         GO TO IKS-040.
001890     IF TSK-ZNGP(4) > W-DATE
001900         MOVE TSK-ZNGP(4) TO W-DATE.
001910     IF TSK-ZNGP(5) > W-DATE
001920         MOVE TSK-ZNGP(5) TO W-DATE.
001930     GO TO IKS-020.
001940 IKS-040.
001950     CLOSE TSKF.
001960     IF W-DATE = ZERO
001970         DISPLAY E-ME1 E-ME99
001980         GO TO IKS-EX.
001990*
002000     DISPLAY D-DATE.
002010 IKS-060.
002020     ACCEPT A-DMM.
002030     IF ESTAT NOT = HTB AND SKP
002040         GO TO IKS-060.
002050     IF W-DMM = 9
002060         GO TO IKS-EX.
002070     IF W-DMM NOT = 1
002080         GO TO IKS-060.
002090*
002100     OPEN I-O TSKF.
002110 IKS-160.
002120     READ TSKF NEXT RECORD AT END
002130         GO TO IKS-220.
002140     IF TSK-ZNGP(4) = ZERO
002150         GO TO IKS-160.
002160     IF W-DATE NOT = TSK-ZNGP(4) AND TSK-ZNGP(5)
002170         GO TO IKS-160.
002180*
002190     IF TSK-ZNGP(5) = ZERO
002200         IF TSK-ZNGP(4) = W-DATE
002210             MOVE ZERO TO TSK-ZSD(4).
002220     IF TSK-ZNGP(5) = W-DATE
002230         MOVE ZERO TO TSK-ZSD(5).
002240*
002250     REWRITE TSK-R INVALID KEY
002260         CLOSE TSKF
002270         DISPLAY E-STAT E-ME2 E-TSK E-ME99
002280         GO TO IKS-EX.
002290     GO TO IKS-160.
002300 IKS-220.
002310     CLOSE TSKF.
002320*
002330     OPEN I-O SKDF.
002340 IKS-240.
002350     READ SKDF NEXT RECORD AT END
002360         GO TO IKS-260.
002370     IF SKD-SKD NOT = W-DATE
002380         GO TO IKS-240.
002390     MOVE ZERO TO SKD-SNO.
002400     REWRITE SKD-R INVALID KEY
002410         DISPLAY E-STAT E-ME3 E-SKD E-ME99
002420         GO TO IKS-260.
002430     GO TO IKS-240.
002440 IKS-260.
002450     CLOSE SKDF.
002460*
002470     OPEN I-O SM-F.
002480 IKS-280.
002490     READ SM-F AT END
002500         GO TO IKS-300.
002510     IF SM-PC NOT = 0
002520         GO TO IKS-280.
002530     IF SM-DATE NOT = W-DATE
002540         GO TO IKS-280.
002550     MOVE 2 TO SM-PC.
002560     REWRITE SM-R.
002570     GO TO IKS-280.
002580 IKS-300.
002590     CLOSE SM-F.
002600*
002610     OPEN I-O TUKF.
002620 IKS-320.
002630     READ TUKF NEXT RECORD AT END
002640         GO TO IKS-980.
002650*****IF TUK-DC NOT = 4                                            D.001201
002660*****    GO TO IKS-320.                                           D.001201
002670*****IF TUK-DATE NOT = W-DATE                                     D.001201
002680     IF (TUK-DC = 4) AND (TUK-DATE = W-DATE)                      I.001201
002690         GO TO IKS-360.                                           I.001201
002700     IF (TUK-DC NOT = 4) AND (TUK-SKD = W-DATE)                   I.001201
002710         GO TO IKS-340.                                           I.001201
002720     GO TO IKS-320.
002730 IKS-340.                                                         I.001201
002740     MOVE ZERO TO TUK-SKD.                                        I.001201
002750     REWRITE TUK-R INVALID KEY                                    I.001201
002760         DISPLAY E-STAT E-ME7 E-TUK E-ME99                        I.001201
002770         GO TO IKS-980.                                           I.001201
002780     GO TO IKS-320.                                               I.001201
002790 IKS-360.                                                         I.001201
002800     DELETE TUKF INVALID KEY
002810         DISPLAY E-STAT E-ME6 E-TUK E-ME99
002820         GO TO IKS-980.
002830     GO TO IKS-320.
002840 IKS-980.
002850     CLOSE TUKF.
002860 IKS-EX.
002870     EXIT.
002880*-------------------------------------------------------------------------
002890 TBS-RTN.
002900     OPEN I-O TSKF.
002910     OPEN I-O SKDF.
002920     OPEN INPUT T-M.
002930     OPEN I-O TUKF.
002940 TBS-020.
002950     DISPLAY D-MID1.
002960 TBS-040.
002970     ACCEPT A-TCD.
002980     DISPLAY E-CL.
002990     IF ESTAT = PF9
003000         GO TO TBS-900.
003010     IF ESTAT NOT = HTB AND SKP
003020         GO TO TBS-040.
003030*
003040     MOVE W-TCD TO T-KEY.
003050     READ T-M WITH UNLOCK INVALID KEY
003060         GO TO TBS-040.
003070     DISPLAY D-TNA.
003080*
003090     MOVE W-TCD TO TSK-KEY.
003100     READ TSKF INVALID KEY
003110         DISPLAY E-ME1 E-ME98
003120         GO TO TBS-040.
003130     IF ZERO = TSK-ZNGP(4) AND TSK-ZNGP(5)
003140         DISPLAY E-ME1 E-ME98
003150         GO TO TBS-040.
003160     IF TSK-ZNGP(5) = ZERO
003170         MOVE TSK-ZNGP(4) TO W-DATE
003180       ELSE
003190         MOVE TSK-ZNGP(5) TO W-DATE.
003200     DISPLAY D-DATE.
003210 TBS-060.
003220     ACCEPT A-DMM.
003230     IF ESTAT = BTB
003240         GO TO TBS-040.
003250     IF ESTAT NOT = HTB AND SKP
003260         GO TO TBS-060.
003270     IF W-DMM = 9
003280         GO TO TBS-020.
003290     IF W-DMM NOT = 1
003300         GO TO TBS-060.
003310*
003320     IF TSK-ZNGP(5) = ZERO
003330         IF TSK-ZNGP(4) = W-DATE
003340             MOVE ZERO TO TSK-ZSD(4).
003350     IF TSK-ZNGP(5) = W-DATE
003360         MOVE ZERO TO TSK-ZSD(5).
003370*
003380     REWRITE TSK-R INVALID KEY
003390         DISPLAY E-STAT E-ME2 E-TSK E-ME99
003400         GO TO TBS-900.
003410 TBS-080.
003420     MOVE SPACE TO SKD-KEY.
003430     MOVE W-TCD TO SKD-TCD.
003440     START SKDF KEY NOT < SKD-KEY INVALID KEY
003450         GO TO TBS-120.
003460 TBS-100.
003470     READ SKDF NEXT RECORD AT END
003480         GO TO TBS-120.
003490     IF SKD-TCD NOT = W-TCD
003500         GO TO TBS-120.
003510     IF SKD-SKD NOT = W-DATE
003520         GO TO TBS-100.
003530     MOVE ZERO TO SKD-SNO.
003540     REWRITE SKD-R INVALID KEY
003550         DISPLAY E-STAT E-ME3 E-ME99
003560         GO TO TBS-900.
003570     GO TO TBS-100.
003580 TBS-120.
003590     OPEN I-O SM-F.
003600 TBS-140.
003610     READ SM-F AT END
003620         DISPLAY E-ME4 E-ME99
003630         DISPLAY E-CL
003640         GO TO TBS-160.
003650     IF SM-PC NOT = 0
003660         GO TO TBS-140.
003670     IF SM-TCD NOT = W-TCD
003680         GO TO TBS-140.
003690     IF SM-DATE NOT = W-DATE
003700         GO TO TBS-140.
003710*
003720     MOVE 2 TO SM-PC.
003730     REWRITE SM-R.
003740     CLOSE SM-F.
003750 TBS-160.
003760     MOVE 0 TO W-DC.                                              I.001201
003770     MOVE SPACE TO TUK-KEY.
003780     MOVE W-TCD TO TUK-TCD.
003790     START TUKF KEY NOT < TUK-KEY INVALID KEY
003800         DISPLAY E-ME5 E-ME99
003810         DISPLAY E-CL
003820         GO TO TBS-900.
003830 TBS-180.
003840     READ TUKF NEXT RECORD AT END
003850         GO TO TBS-240.                                           I.001201
003860*****    DISPLAY E-ME5 E-ME99                                     D.001201
003870*****    DISPLAY E-CL                                             D.001201
003880*****    GO TO TBS-020.                                           D.001201
003890     IF TUK-TCD NOT = W-TCD
003900         GO TO TBS-240.                                           I.001201
003910*****    DISPLAY E-ME5 E-ME99                                     D.001201
003920*****    DISPLAY E-CL                                             D.001201
003930*****    GO TO TBS-020.                                           D.001201
003940*****IF TUK-DC NOT = 4                                            D.001201
003950*****    GO TO TBS-180.                                           D.001201
003960*****IF TUK-DATE NOT = W-DATE                                     D.001201
003970     IF (TUK-DC = 4) AND (TUK-DATE = W-DATE)                      I.001201
003980         GO TO TBS-220.                                           I.001201
003990     IF (TUK-DC NOT = 4) AND (TUK-SKD = W-DATE)                   I.001201
004000         GO TO TBS-200.                                           I.001201
004010     GO TO TBS-180.
004020 TBS-200.                                                         I.001201
004030     MOVE ZERO TO TUK-SKD.                                        I.001201
004040     REWRITE TUK-R INVALID KEY                                    I.001201
004050         DISPLAY E-STAT E-ME7 E-TUK E-ME99                        I.001201
004060         GO TO TBS-900.                                           I.001201
004070     GO TO TBS-180.                                               I.001201
004080 TBS-220.                                                         I.001201
004090     DELETE TUKF INVALID KEY
004100         DISPLAY E-STAT E-ME6 E-TUK E-ME99
004110         GO TO TBS-900.
004120     MOVE 1 TO W-DC.                                              I.001201
004130     GO TO TBS-180.
004140 TBS-240.                                                         I.001201
004150     IF W-DC = 0                                                  I.001201
004160         DISPLAY E-ME5 E-ME99                                     I.001201
004170         DISPLAY E-CL.                                            I.001201
004180     GO TO TBS-020.
004190 TBS-900.
004200     CLOSE TSKF.
004210     CLOSE SKDF.
004220     CLOSE T-M.
004230     CLOSE TUKF.
004240 TBS-EX.
004250     EXIT.

000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. HMG880.
000030*********************************************************
000040*    PROGRAM         :  履物出荷・値引データ作成        *
000050*                    :  （月末品名振替）                *
000060*    COMPILE TYPE    :  COBOL                           *
000070*********************************************************
000080 ENVIRONMENT DIVISION.
000090 CONFIGURATION SECTION.
000100 SOURCE-COMPUTER. SYSTEM3100.
000110 OBJECT-COMPUTER. SYSTEM3100.
000120 INPUT-OUTPUT SECTION.
000130 FILE-CONTROL.
000140     COPY LIBCSE.
000150     SELECT STWF ASSIGN TO STW-MSD.
000160     SELECT S-TRAN ASSIGN TO S-MSD
000170         FILE STATUS IS ERR-STAT.
000180     SELECT HKBM  ASSIGN TO HKB-MSD
000190         ORGANIZATION INDEXED
000200         ACCESS MODE RANDOM
000210         RECORD KEY HKB-KEY
000220         FILE STATUS IS ERR-STAT.
000230     SELECT CALNM ASSIGN TO CALN-MSD
000240         ORGANIZATION INDEXED
000250         ACCESS MODE DYNAMIC
000260         RECORD KEY CL-KEY
000270         FILE STATUS IS ERR-STAT.
000280 I-O-CONTROL.
000290     APPLY SHARED-MODE ON HKBM
000300     APPLY SHARED-MODE ON CALNM
000310     APPLY SHARED-MODE ON M-DATE.
000320 DATA DIVISION.
000330 FILE SECTION.
000340     COPY LIBFDD.
000350     COPY LIHKBM.
000360     COPY LICAL.
000370 FD  STWF
000380     BLOCK  2 RECORDS
000390     LABEL RECORD IS STANDARD
000400     VALUE OF IDENTIFICATION WK0128ID.
000410 01  STW-R.
000420     02  STW-DNO        PIC  9(006).
000430     02  STW-GNO        PIC  9(001).
000440     02  STW-DATE       PIC  9(008).
000450     02  STW-TCD        PIC  9(004).
000460     02  STW-HCD        PIC  9(006).
000470     02  STW-SIZ        PIC  9(001).
000480     02  STW-SUS.
000490       03  STW-SUSD  OCCURS  10.
000500         04  STW-SU     PIC S9(004)  COMP-3.
000510     02  STW-SUT        PIC S9(005).
000520     02  STW-BT         PIC S9(005).
000530     02  STW-KIN        PIC S9(008).
000540     02  STW-CSC        PIC  9(001).
000550     02  STW-DC         PIC  9(001).
000560     02  STW-FT         PIC  9(005).
000570     02  STW-CCD        PIC  9(003).
000580     02  STW-BC1        PIC  9(002).
000590     02  STW-BC2        PIC  9(002).
000600     02  STW-BC3        PIC  9(002).
000610     02  STW-SOK        PIC  9(001).
000620     02  STW-TC2        PIC  9(002).
000630     02  STW-FKC        PIC  9(002).
000640     02  STW-HSC        PIC  9(001).
000650     02  STW-KOSU       PIC  9(003).
000660     02  STW-FRC        PIC  9(001).
000670     02  STW-TCD2       PIC  9(004).
000680     02  STW-BIK        PIC  X(010).
000690     02  STW-SDT        PIC  9(008).
000700     02  F              PIC  X(004).
000710     02  STW-DHC        PIC  9(001).
000720     02  STW-UNC        PIC  9(001).
000730 FD  S-TRAN
000740     BLOCK  2 RECORDS
000750     LABEL RECORD IS STANDARD
000760     VALUE OF IDENTIFICATION "STRAN".
000770 01  S-R.
000780     02  S-DNO          PIC  9(006).
000790     02  S-GNO          PIC  9(001).
000800     02  S-DATE         PIC  9(008).
000810     02  S-TCD          PIC  9(004).
000820     02  S-DT1.
000830       03  S-HCD        PIC  9(006).
000840       03  S-SIZ        PIC  9(001).
000850       03  S-SUS.
000860         04  S-SUSD  OCCURS  10.
000870           05  S-SU     PIC S9(004)  COMP-3.
000880       03  S-SUT        PIC S9(005).
000890       03  S-BT         PIC S9(005).
000900       03  S-KIN        PIC S9(008).
000910       03  S-CSC        PIC  9(001).
000920       03  S-DC         PIC  9(001).
000930       03  S-FT         PIC  9(005).
000940       03  S-CCD        PIC  9(003).
000950       03  S-BC1        PIC  9(002).
000960       03  S-BC2        PIC  9(002).
000970       03  S-BC3        PIC  9(002).
000980       03  S-SOK        PIC  9(001).
000990       03  S-TC2        PIC  9(002).
001000       03  S-FKC        PIC  9(002).
001010       03  S-HSC        PIC  9(001).
001020       03  S-KOSU       PIC  9(003).
001030       03  S-FRC        PIC  9(001).
001040       03  S-TCD2       PIC  9(004).
001050       03  S-BIK        PIC  X(010).
001060       03  S-SDT        PIC  9(008).
001070       03  F            PIC  X(004).
001080     02  S-DT2   REDEFINES S-DT1.
001090       03  S-BI         PIC  N(024).
001100       03  S-HANO       PIC  9(006).                              I.090105
001110       03  F            PIC  X(030).                              I.090105
001120*****  03  S-HANO.                                                D.090105
001130*****    04  S-HA    OCCURS   6  PIC  9(006).                     D.090105
001140       03  S-TAX        PIC S9(007).
001150       03  S-UZZ        PIC S9(007).
001160       03  S-UZ         PIC S9(009).
001170     02  S-DHC          PIC  9(001).
001180     02  S-UNC          PIC  9(001).
001190 WORKING-STORAGE SECTION.
001200 77  W-FILE             PIC  X(013).
001210 77  WK0128ID           PIC  X(009) VALUE SPACE.
001220 01  STN-NO.
001230     02  STN-NO1        PIC  X(003).
001240     02  STN-NO2        PIC  X(003).
001250 01  W-FID.
001260     02  W-FID1         PIC  X(006) VALUE "WK0128".
001270     02  W-FID2         PIC  X(003).
001280 01  ERR-STAT           PIC  X(002).
001290 01  W-DATA.
001300     02  W-NGP          PIC  9(008).
001310     02  W-NGPD  REDEFINES W-NGP.
001320       03  W-NG         PIC  9(006).
001330       03  W-NGD   REDEFINES W-NG.
001340         04  W-NEN      PIC  9(004).
001350         04  W-NEND  REDEFINES W-NEN.
001360           05  W-NEN1   PIC  9(002).
001370           05  W-NEN2   PIC  9(002).
001380         04  W-GET      PIC  9(002).
001390       03  W-NGL   REDEFINES W-NG.
001400         04  F          PIC  9(002).
001410         04  W-NGS      PIC  9(004).
001420       03  W-PEY        PIC  9(002).
001430     02  CHK            PIC  9(001).
001440     02  W-DMM          PIC  9(001).
001450     02  W-DC           PIC  9(001).
001460     02  W-DS           PIC  9(001).
001470     02  W-DSD          PIC  9(001).
001480     02  W-TCD          PIC  9(004).
001490     02  W-UNC          PIC  9(001).
001500     02  W-DNO          PIC  9(006).
001510     02  W-GNO          PIC  9(001).
001520     COPY LSTAT.
001530 SCREEN SECTION.
001540 SD  C-CRT
001550     END STATUS IS ESTAT.
001560 01  C-CLEAR.
001570     02  LINE   1  CLEAR SCREEN.
001580 01  C-MID.
001590     02  LINE   3  COLUMN  15  PIC  N(022) VALUE
001600          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001610     02  LINE   4  COLUMN  15  PIC  N(022) VALUE
001620          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001630     02  LINE   5  COLUMN  15  PIC  N(022) VALUE
001640          NC"＊＊＊　　　　　　　　　　　　　　　　＊＊＊".
001650     02  LINE   6  COLUMN  15  PIC  N(022) VALUE
001660          NC"＊＊＊　　履物出荷・値引データ作成　　＊＊＊".
001670     02  LINE   7  COLUMN  15  PIC  N(022) VALUE
001680          NC"＊＊＊　　　　（月末品名振替）　　　　＊＊＊".
001690     02  LINE   8  COLUMN  15  PIC  N(022) VALUE
001700          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001710     02  LINE   9  COLUMN  15  PIC  N(022) VALUE
001720          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001730     02  LINE  14  COLUMN  25  PIC  X(023) VALUE
001740          "【  '  年   月   日  】".
001750     02  LINE  20  COLUMN  26  PIC  X(022) VALUE
001760          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001770 01  C-ACP.
001780     02  A-DMM   LINE  20  COLUMN  43  PIC  9(001)
001790          USING W-DMM   CHECK OVERFLOW NO IFC.
001800     02  A-CHK   LINE  24  COLUMN  55  PIC  9(001)
001810          USING CHK     CHECK OVERFLOW NO IFC.
001820 01  C-DSP.
001830     02  D-NGP   LINE  14.
001840       03  COLUMN  30  PIC  9(002) FROM  W-NEN2.
001850       03  COLUMN  35  PIC Z9      FROM  W-GET.
001860       03  COLUMN  40  PIC Z9      FROM  W-PEY.
001870 01  C-ERR.
001880     02  LINE  24.
001890       03  E-ME1   COLUMN  15  PIC  X(018) VALUE
001900            "***  CALNF ﾅｼ  ***".
001910       03  E-ME2   COLUMN  15  PIC  X(025) VALUE
001920            "***  STRAN WRITE ｴﾗｰ  ***".
001930       03  E-ME3  COLUMN  15  PIC  X(017) VALUE
001940            "***  ﾃﾞｰﾀ ﾅｼ  ***".
001950       03  E-ME4  COLUMN  15  PIC  X(017) VALUE
001960            "***  HKBM ﾅｼ  ***".
001970       03  E-ME5  COLUMN  15  PIC  X(026) VALUE
001980            "***  HKBM REWRITE ｴﾗｰ  ***".
001990       03  E-ME6  COLUMN  15  PIC  X(027) VALUE
002000            "***  DATEM REWRITE ｴﾗｰ  ***".
002010       03  E-ME50  COLUMN  15  PIC  X(028) VALUE
002020            "***  未更新データ　有り  ***".
002030       03  E-ME51  COLUMN  15  PIC  X(041) VALUE
002040            "未更新データ　有り     消す  OK=1 NO=5   ".
002050     COPY LSSEM.
002060     COPY LIBSCR.
002070 PROCEDURE DIVISION.
002080 M-05.
002090     DISPLAY C-CLEAR.
002100     DISPLAY C-MID.
002110     PERFORM CAL-RTN THRU CAL-EX.
002120     DISPLAY D-NGP.
002130     IF W-PEY = ZERO
002140         MOVE 255 TO COMPLETION-CODE
002150         DISPLAY E-ME1 E-ME99
002160         GO TO M-95.
002170 M-10.
002180     ACCEPT A-DMM.
002190     IF ESTAT NOT = HTB AND SKP
002200         GO TO M-10.
002210     IF W-DMM = 9
002220         MOVE 255 TO COMPLETION-CODE
002230         GO TO M-95.
002240     IF W-DMM NOT = 1
002250         GO TO M-10.
002260*
002270     OPEN INPUT S-TRAN.
002280     READ S-TRAN AT END
002290         GO TO M-25.
002300 M-15.
002310     IF S-DHC NOT = 0
002320         MOVE 255 TO COMPLETION-CODE
002330         CLOSE S-TRAN
002340         DISPLAY E-ME50 E-ME99
002350         GO TO M-95.
002360     READ S-TRAN AT END
002370         DISPLAY E-ME51 E-ME99
002380         GO TO M-20.
002390     GO TO M-15.
002400 M-20.
002410     ACCEPT A-CHK.
002420     IF ESTAT NOT = HTB AND SKP
002430         GO TO M-20.
002440     IF CHK = 1
002450         GO TO M-25.
002460     IF CHK = 5
002470         MOVE 255 TO COMPLETION-CODE
002480         CLOSE S-TRAN
002490         GO TO M-95.
002500     GO TO M-20.
002510 M-25.
002520     CLOSE S-TRAN.
002530*
002540     OPEN INPUT HKBM.
002550     MOVE SPACE TO HKB-KEY.
002560     MOVE "05" TO HKB-NO.
002570     READ HKBM WITH UNLOCK INVALID KEY
002580         MOVE 255 TO COMPLETION-CODE
002590         CLOSE HKBM
002600         DISPLAY E-ME78 E-ME4 E-ME99
002610         GO TO M-95.
002620     MOVE HKB-UNN TO W-DNO.
002630     CLOSE HKBM.
002640*
002650     CALL "CBLSTNNO" USING STN-NO.
002660     MOVE STN-NO2 TO W-FID2.
002670     MOVE W-FID TO WK0128ID.
002680     OPEN INPUT STWF.
002690     OPEN OUTPUT S-TRAN.
002700*
002710     READ STWF AT END
002720         MOVE 255 TO COMPLETION-CODE
002730         DISPLAY E-ME3 E-ME99
002740         GO TO M-90.
002750     MOVE 0 TO W-DSD.
002760     IF STW-UNC = 0
002770         IF STW-DC = 0 OR 6
002780             MOVE 1 TO W-DSD
002790           ELSE
002800             IF STW-DC = 1 OR 2 OR 5
002810                 MOVE 2 TO W-DSD
002820               ELSE
002830                 IF STW-SUT >= 0
002840                     MOVE 1 TO W-DSD
002850                   ELSE
002860                     MOVE 2 TO W-DSD.
002870     IF STW-UNC = 1
002880*****    IF STW-SUT >= 0                                          D.020806
002890         IF STW-KIN >= 0                                          I.020806
002900             MOVE 2 TO W-DSD
002910           ELSE
002920             MOVE 1 TO W-DSD.
002930 M-35.
002940     MOVE STW-DC TO W-DC.
002950     MOVE W-DSD TO W-DS.
002960     MOVE STW-TCD TO W-TCD.
002970 M-40.
002980     MOVE STW-UNC TO W-UNC.
002990     ADD 1 TO W-DNO.
003000     MOVE 0 TO W-GNO.
003010 M-45.
003020     ADD 1 TO W-GNO.
003030     IF W-GNO NOT = 7
003040         GO TO M-50.
003050     PERFORM WRB-RTN THRU WRB-EX.
003060     IF COMPLETION-CODE = 255
003070         GO TO M-90.
003080     PERFORM HKB-RTN THRU HKB-EX.
003090     IF COMPLETION-CODE = 255
003100         GO TO M-90.
003110     GO TO M-40.
003120 M-50.
003130     PERFORM WRM-RTN THRU WRM-EX.
003140     IF COMPLETION-CODE = 255
003150         GO TO M-90.
003160*
003170     READ STWF AT END
003180         GO TO M-55.
003190     MOVE 0 TO W-DSD.
003200     IF STW-UNC = 0
003210         IF STW-DC = 0 OR 6
003220             MOVE 1 TO W-DSD
003230           ELSE
003240             IF STW-DC = 1 OR 2 OR 5
003250                 MOVE 2 TO W-DSD
003260               ELSE
003270                 IF STW-SUT >= 0
003280                     MOVE 1 TO W-DSD
003290                   ELSE
003300                     MOVE 2 TO W-DSD.
003310     IF STW-UNC = 1
003320*****    IF STW-SUT >= 0                                          D.020806
003330         IF STW-KIN >= 0                                          I.020806
003340             MOVE 2 TO W-DSD
003350           ELSE
003360             MOVE 1 TO W-DSD.
003370     IF (STW-DC = W-DC) AND (W-DS = W-DSD) AND (STW-TCD = W-TCD)
003380         GO TO M-45.
003390     PERFORM WRB-RTN THRU WRB-EX.
003400     IF COMPLETION-CODE = 255
003410         GO TO M-90.
003420     PERFORM HKB-RTN THRU HKB-EX.
003430     IF COMPLETION-CODE = 255
003440         GO TO M-90.
003450     GO TO M-35.
003460 M-55.
003470     PERFORM WRB-RTN THRU WRB-EX.
003480     IF COMPLETION-CODE = 255
003490         GO TO M-90.
003500     PERFORM HKB-RTN THRU HKB-EX.
003510 M-90.
003520     CLOSE STWF.
003530     CLOSE S-TRAN.
003540     IF COMPLETION-CODE = 255
003550         OPEN OUTPUT S-TRAN
003560         CLOSE S-TRAN
003570         GO TO M-95.
003580*
003590     OPEN I-O M-DATE.
003600     MOVE "01" TO DATE-KEY.
003610     READ M-DATE INVALID KEY
003620         MOVE 255 TO COMPLETION-CODE
003630         CLOSE M-DATE
003640         DISPLAY ERR-DATE ERR-BUZ
003650         GO TO M-95.
003660     MOVE 1 TO DATE-HFC.
003670     REWRITE DATE-R INVALID KEY
003680         MOVE 255 TO COMPLETION-CODE
003690         DISPLAY E-ME6 E-ME99.
003700     CLOSE  M-DATE.
003710 M-95.
003720     DISPLAY C-CLEAR.
003730     STOP RUN.
003740 CAL-RTN.
003750     COPY LIBCPR.
003760     MOVE ZERO TO W-NGP.
003770     MOVE D-NHNG TO W-NGS.
003780     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
003790         ADD DATE-NC1 TO W-NEN.
003800     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
003810         ADD DATE-NC2 TO W-NEN.
003820*
003830     OPEN INPUT CALNM.
003840     MOVE ZERO TO CL-KEY.
003850     MOVE W-NGP TO CL-KEY.
003860     START CALNM KEY NOT < CL-KEY INVALID KEY
003870         GO TO CAL-020.
003880 CAL-010.
003890     READ CALNM NEXT RECORD WITH UNLOCK AT END
003900         GO TO CAL-020.
003910     IF CL-NG = W-NG
003920         MOVE CL-KEY TO W-NGP
003930         GO TO CAL-010.
003940 CAL-020.
003950     CLOSE CALNM.
003960 CAL-EX.
003970     EXIT.
003980 WRM-RTN.
003990     MOVE ZERO TO S-R.
004000     MOVE STW-R TO S-R.
004010     MOVE W-DNO TO S-DNO.
004020     MOVE W-GNO TO S-GNO.
004030     MOVE W-NGP TO S-DATE.
004040     WRITE S-R.
004050     IF ERR-STAT = "00"
004060         GO TO WRM-EX.
004070*
004080     DISPLAY E-STAT E-ME2 E-ME99.
004090     IF ERR-STAT NOT = "34"
004100         MOVE 255 TO COMPLETION-CODE
004110         DISPLAY E-ME78 E-ME99
004120         GO TO WRM-EX.
004130     DISPLAY E-CL.
004140     CLOSE S-TRAN.
004150     MOVE "STRAN        " TO W-FILE.
004160     DISPLAY E-ME71 E-ME98 STOP " ".
004170     DISPLAY E-CL.
004180     OPEN EXTEND S-TRAN.
004190     GO TO WRM-RTN.
004200 WRM-EX.
004210     EXIT.
004220 WRB-RTN.
004230*****MOVE ZERO TO S-R.                                            D.090105
004240     INITIALIZE S-R.                                              I.090105
004250     MOVE SPACE TO S-BI.
004260     MOVE W-DNO TO S-DNO.
004270     MOVE 9 TO S-GNO.
004280     MOVE W-NGP TO S-DATE.
004290     MOVE W-TCD TO S-TCD.
004300     MOVE NC"＊　（在庫振替）" TO S-BI.
004310     MOVE W-UNC TO S-UNC.
004320     WRITE S-R.
004330     IF ERR-STAT = "00"
004340         GO TO WRB-EX.
004350*
004360     DISPLAY E-STAT E-ME2 E-ME99.
004370     IF ERR-STAT NOT = "34"
004380         MOVE 255 TO COMPLETION-CODE
004390         DISPLAY E-ME78 E-ME99
004400         GO TO WRB-EX.
004410     DISPLAY E-CL.
004420     CLOSE S-TRAN.
004430     MOVE "STRAN        " TO W-FILE.
004440     DISPLAY E-ME71 E-ME98 STOP " ".
004450     DISPLAY E-CL.
004460     OPEN EXTEND S-TRAN.
004470     GO TO WRB-RTN.
004480 WRB-EX.
004490     EXIT.
004500 HKB-RTN.
004510     OPEN I-O HKBM.
004520     MOVE SPACE TO HKB-KEY.
004530     MOVE "05" TO HKB-NO.
004540     READ HKBM INVALID KEY
004550         MOVE 255 TO COMPLETION-CODE
004560         CLOSE HKBM
004570         DISPLAY E-ME78 E-ME4 E-ME99
004580         GO TO HKB-EX.
004590     MOVE W-DNO TO HKB-UNN.
004600     IF HKB-UNN = ZERO
004610         MOVE 1 TO HKB-UNN.
004620     REWRITE HKB-R INVALID KEY
004630         MOVE 255 TO COMPLETION-CODE
004640         DISPLAY E-STAT E-ME78 E-ME5 E-ME99.
004650     CLOSE HKBM.
004660 HKB-EX.
004670     EXIT.

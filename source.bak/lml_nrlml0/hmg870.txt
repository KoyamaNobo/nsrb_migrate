000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. HMG870.
000030*********************************************************
000040*    履物出荷トランワーク　作成　（出荷分）             *
000050*********************************************************
000060 ENVIRONMENT DIVISION.
000070 CONFIGURATION SECTION.
000080 SOURCE-COMPUTER. SYSTEM3100.
000090 OBJECT-COMPUTER. SYSTEM3100.
000100 INPUT-OUTPUT SECTION.
000110 FILE-CONTROL.
000120     SELECT ZCMF ASSIGN TO ZCM-MSD.
000130     SELECT ZCOF ASSIGN TO ZCO-MSD
000140         ORGANIZATION IS INDEXED
000150         ACCESS MODE IS DYNAMIC
000160         RECORD KEY IS ZCO-KEY
000170         FILE STATUS IS ERR-STAT.
000180     SELECT HI-M ASSIGN TO HI1-MSD HI2-MSD
000190         ORGANIZATION IS INDEXED
000200         ACCESS MODE IS RANDOM
000210         RECORD KEY IS HI-KEY
000220         ALTERNATE RECORD KEY IS HI-KEY2
000230         FILE STATUS IS ERR-STAT.
000240     SELECT STROF ASSIGN TO STRO-MSD.
000250     SELECT STRNF ASSIGN TO STRN-MSD.
000260 I-O-CONTROL.
000270     APPLY SHARED-MODE ON HI-M.
000280 DATA DIVISION.
000290 FILE SECTION.
000300     COPY LIHIM.
000310 FD  ZCMF
000320     BLOCK  1 RECORDS
000330     LABEL RECORD IS STANDARD
000340     VALUE OF IDENTIFICATION IS WK0512ID.
000350 01  ZCM-R.
000360     02  ZCM-KEY.
000370       03  ZCM-MHCD     PIC  9(006).
000380       03  ZCM-HCD      PIC  9(006).
000390       03  ZCM-SIZ      PIC  9(001).
000400     02  ZCM-ASU.
000410       03  ZCM-SUD   OCCURS  10.
000420         04  ZCM-SU     PIC S9(006).
000430     02  F              PIC  X(439).
000440 FD  ZCOF
000450     BLOCK  3 RECORDS
000460     LABEL RECORD IS STANDARD
000470     VALUE OF IDENTIFICATION IS "ZCOF".
000480 01  ZCO-R.
000490     02  ZCO-KEY.
000500       03  ZCO-MHCD     PIC  9(006).
000510       03  ZCO-HCD      PIC  9(006).
000520       03  ZCO-SIZ      PIC  9(001).
000530     02  ZCO-ASU.
000540       03  ZCO-SUD   OCCURS  10.
000550         04  ZCO-SU     PIC S9(006).
000560     02  ZCO-CSU        PIC S9(006).                              I.020611
000570     02  F              PIC  X(006).                              I.020611
000580*****02  F              PIC  X(012).                              D.020611
000590 FD  STROF
000600     BLOCK  1 RECORDS
000610     LABEL RECORD IS STANDARD
000620     VALUE OF IDENTIFICATION WK0256ID.
000630 01  STRO-R.
000640     02  STRO-DNO       PIC  9(006).
000650     02  STRO-GNO       PIC  9(001).
000660     02  STRO-DATE      PIC  9(008).
000670     02  STRO-TCD       PIC  9(004).
000680     02  STRO-HCD       PIC  9(006).
000690     02  STRO-SIZ       PIC  9(001).
000700     02  STRO-ASUD.
000710       03  STRO-SUD   OCCURS  10.
000720         04  STRO-SU    PIC S9(004) COMP-3.
000730     02  STRO-SUT       PIC S9(005).
000740     02  STRO-BT        PIC  9(005).
000750     02  STRO-KIN       PIC S9(008).
000760     02  STRO-CSC       PIC  9(001).
000770     02  STRO-DC        PIC  9(001).
000780     02  STRO-FT        PIC  9(005).
000790     02  STRO-CCD       PIC  9(003).
000800     02  STRO-BC        PIC  9(006).
000810     02  STRO-SOC       PIC  9(001).
000820     02  STRO-TNC       PIC  9(002).
000830     02  STRO-FKC       PIC  9(002).
000840     02  STRO-SHZ       PIC  9(001).
000850     02  STRO-KSU       PIC  9(003).
000860     02  STRO-FRC       PIC  9(001).
000870     02  STRO-TCD2      PIC  9(004).
000880     02  STRO-GBI       PIC  X(010).
000890     02  STRO-SKD       PIC  9(008).
000900     02  STRO-BMC       PIC  9(002).                              I.020517
000910     02  STRO-BMNO      PIC  9(001).                              I.020517
000920     02  F              PIC  X(001).                              I.020517
000930*****02  F              PIC  X(004).                              D.020517
000940     02  STRO-DHC       PIC  9(001).
000950     02  STRO-SNC       PIC  9(001).
000960     02  F              PIC  X(128).
000970 FD  STRNF
000980     BLOCK  2 RECORDS
000990     LABEL RECORD IS STANDARD
001000     VALUE OF IDENTIFICATION WK0128ID.
001010 01  STRN-R.
001020     02  STRN-DNO       PIC  9(006).
001030     02  STRN-GNO       PIC  9(001).
001040     02  STRN-DATE      PIC  9(008).
001050     02  STRN-TCD       PIC  9(004).
001060     02  STRN-HCD       PIC  9(006).
001070     02  STRN-SIZ       PIC  9(001).
001080     02  STRN-ASUD.
001090       03  STRN-SUD   OCCURS  10.
001100         04  STRN-SU    PIC S9(004) COMP-3.
001110     02  STRN-SUT       PIC S9(005).
001120     02  STRN-BT        PIC  9(005).
001130     02  STRN-KIN       PIC S9(008).
001140     02  STRN-CSC       PIC  9(001).
001150     02  STRN-DC        PIC  9(001).
001160     02  STRN-FT        PIC  9(005).
001170     02  STRN-CCD       PIC  9(003).
001180     02  STRN-BC        PIC  9(006).
001190     02  STRN-SOC       PIC  9(001).
001200     02  STRN-TNC       PIC  9(002).
001210     02  STRN-FKC       PIC  9(002).
001220     02  STRN-SHZ       PIC  9(001).
001230     02  STRN-KSU       PIC  9(003).
001240     02  STRN-FRC       PIC  9(001).
001250     02  STRN-TCD2      PIC  9(004).
001260     02  STRN-GBI       PIC  X(010).
001270     02  STRN-SKD       PIC  9(008).
001280     02  STRN-BMC       PIC  9(002).                              I.020517
001290     02  STRN-BMNO      PIC  9(001).                              I.020517
001300     02  F              PIC  X(001).                              I.020517
001310*****02  F              PIC  X(004).                              D.020517
001320     02  STRN-DHC       PIC  9(001).
001330     02  STRN-SNC       PIC  9(001).
001340 WORKING-STORAGE SECTION.
001350 77  W-END              PIC  9(001) VALUE 0.
001360 77  W-FILE             PIC  X(013).
001370 77  WK0128ID           PIC  X(009) VALUE SPACE.
001380 77  WK0256ID           PIC  X(009) VALUE SPACE.
001390 77  WK0512ID           PIC  X(009) VALUE SPACE.
001400 01  STN-NO.
001410     02  STN-NO1        PIC  X(003).
001420     02  STN-NO2        PIC  X(003).
001430 01  W-FID1.
001440     02  W-FID11        PIC  X(006) VALUE "WK0128".
001450     02  W-FID12        PIC  X(003).
001460 01  W-FID2.
001470     02  W-FID21        PIC  X(006) VALUE "WK0256".
001480     02  W-FID22        PIC  X(003).
001490 01  W-FID3.
001500     02  W-FID31        PIC  X(006) VALUE "WK0512".
001510     02  W-FID32        PIC  X(003).
001520 01  W-DATA.
001530     02  W-RE           PIC  9(001).
001540     02  CNT            PIC  9(002).
001550     02  CHK            PIC  9(001).
001560     02  W-SU           PIC S9(004).
001570     02  W-SUD          PIC S9(006).
001580     02  W-ASU          PIC S9(006).
001590     02  W-AKIN         PIC S9(008).
001600 01  ERR-STAT           PIC  X(002).
001610 SCREEN SECTION.
001620 SD  C-CRT
001630     END STATUS IS ESTAT.
001640 01  C-CLEAR.
001650     02  C-CL    LINE   1  CLEAR SCREEN.
001660 01  C-MID.
001670     02  LINE   3  COLUMN  10  PIC N(021) VALUE
001680          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001690     02  LINE   4  COLUMN  10  PIC N(021) VALUE
001700          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001710     02  LINE   5  COLUMN  10  PIC N(021) VALUE
001720          NC"＊＊＊　　　　　　　　　　　　　　　＊＊＊".
001730     02  LINE   6  COLUMN  10  PIC N(021) VALUE
001740          NC"＊＊＊　　出荷トランワーク　作成　　＊＊＊".
001750     02  LINE   7  COLUMN  10  PIC N(021) VALUE
001760          NC"＊＊＊　　　　　　　　　　　　　　　＊＊＊".
001770     02  LINE   8  COLUMN  10  PIC N(021) VALUE
001780          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001790     02  LINE   9  COLUMN  10  PIC N(021) VALUE
001800          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001810 01  C-ERR.
001820     02  LINE  24.
001830       03  E-ME1   COLUMN  15  PIC  X(018) VALUE
001840            "***  DATA ｴﾗｰ  ***".
001850       03  E-ME2   COLUMN  15  PIC  X(017) VALUE
001860            "***  DATA ﾅｼ  ***".
001870       03  E-ME4   COLUMN  15  PIC  X(026) VALUE
001880            "***  ZCOF REWRITE ｴﾗｰ  ***".
001890       03  E-ME5   COLUMN  15  PIC  X(016) VALUE
001900            "***  HIM ﾅｼ  ***".
001910       03  E-ME6   COLUMN  15  PIC  X(021) VALUE
001920            "***  HIM ｻｲｽﾞ ﾅｼ  ***".
001930*****  03  E-ME7   COLUMN  15  PIC  X(025) VALUE                  D.020605
001940       03  E-ME7.                                                 I.020605
001950         04  COLUMN  15  PIC  X(025) VALUE                        I.020605
001960              "***  TOTAL ｶﾞ O ﾃﾞﾅｲ  ***".
001970         04  COLUMN  41  PIC ----,--9    FROM  W-ASU.             I.020605
001980         04  COLUMN  50  PIC ---,---,--9 FROM  W-AKIN.            I.020605
001990       03  E-ME8   COLUMN  15  PIC  X(025) VALUE
002000            "***  ﾌﾘｶｴﾀﾝｶ ｶﾞ ZERO  ***".
002010     COPY LSSEM.
002020 PROCEDURE DIVISION.
002030 M-05.
002040     DISPLAY C-CLEAR.
002050     DISPLAY C-MID.
002060     MOVE ZERO TO W-ASU W-AKIN.
002070     CALL "CBLSTNNO" USING STN-NO.
002080     MOVE STN-NO2 TO W-FID12 W-FID22 W-FID32.
002090     MOVE W-FID2 TO WK0256ID.
002100     MOVE W-FID1 TO WK0128ID.
002110     MOVE W-FID3 TO WK0512ID.
002120     OPEN OUTPUT STRNF.
002130     OPEN INPUT ZCMF.
002140     OPEN I-O ZCOF.
002150     OPEN INPUT HI-M.
002160 M-10.
002170     READ ZCMF AT END
002180         GO TO M-90.
002190     MOVE ZERO TO CNT.
002200 M-15.
002210     ADD 1 TO CNT.
002220     IF CNT > 10
002230         GO TO M-10.
002240 M-20.
002250     IF ZCM-SU(CNT) >= ZERO
002260         GO TO M-15.
002270     COMPUTE W-SUD = -1 * ZCM-SU(CNT).
002280*
002290     MOVE SPACE TO ZCO-KEY.
002300     MOVE ZCM-MHCD TO ZCO-MHCD.
002310     START ZCOF KEY NOT < ZCO-KEY INVALID KEY
002320         GO TO M-10.
002330 M-25.
002340     READ ZCOF NEXT RECORD AT END
002350         GO TO M-15.
002360     IF ZCM-MHCD NOT = ZCO-MHCD
002370         GO TO M-15.
002380     IF ZCM-SIZ NOT = ZCO-SIZ
002390         GO TO M-25.
002400     IF ZCO-SU(CNT) = ZERO
002410         GO TO M-25.
002420*
002430     MOVE 0 TO W-RE.
002440     OPEN INPUT STROF.
002450 M-30.
002460     READ STROF AT END
002470         MOVE 1 TO W-RE
002480         GO TO M-50.
002490     IF STRO-SNC = 1                                              I.020611
002500         GO TO M-30.                                              I.020611
002510     IF STRO-DC = 3 OR 4
002520         GO TO M-30.
002530     IF ZCM-HCD NOT = STRO-HCD
002540         GO TO M-30.
002550     MOVE ZCO-HCD TO HI-KEY.
002560     READ HI-M WITH UNLOCK INVALID KEY
002570         MOVE 255 TO COMPLETION-CODE
002580         CLOSE STROF
002590         DISPLAY E-ME5 E-ME99
002600         GO TO M-90.
002610*****IF STRO-SNC = 1                                              D.020611
002620*****    GO TO M-40.                                              D.020611
002630     IF ZCM-SIZ NOT = STRO-SIZ
002640         GO TO M-30.
002650     IF STRO-SU(CNT) = ZERO
002660         GO TO M-30.
002670     IF STRO-DC = 1 OR 2
002680         MOVE STRO-SU(CNT) TO W-SU
002690         GO TO M-35.
002700*
002710     IF STRO-SU(CNT) <= W-SUD AND <= ZCO-SU(CNT)
002720         MOVE STRO-SU(CNT) TO W-SU.
002730     IF W-SUD <= STRO-SU(CNT) AND <= ZCO-SU(CNT)
002740         MOVE W-SUD TO W-SU.
002750     IF ZCO-SU(CNT) <= W-SUD AND <= STRO-SU(CNT)
002760         MOVE ZCO-SU(CNT) TO W-SU.
002770     IF W-SU = ZERO
002780         GO TO M-30.
002790 M-35.
002800     IF HI-S(ZCM-SIZ,CNT) = 0
002810         MOVE 255 TO COMPLETION-CODE
002820         CLOSE STROF
002830         DISPLAY E-ME6 E-ME99
002840         GO TO M-90.
002850 M-40.
002860     MOVE ZERO TO STRN-R.
002870     MOVE ZERO TO STRN-SU(01) STRN-SU(02) STRN-SU(03) STRN-SU(04)
002880                  STRN-SU(05) STRN-SU(06) STRN-SU(07) STRN-SU(08)
002890                  STRN-SU(09) STRN-SU(10).
002900     MOVE STRO-TCD TO STRN-TCD.
002910     MOVE STRO-TCD2 TO STRN-TCD2.
002920     MOVE STRO-HCD TO STRN-HCD.
002930     MOVE STRO-SIZ TO STRN-SIZ.
002940*****IF STRO-SNC = 0                                              D.020611
002950*****    COMPUTE STRN-SU(CNT) = -1 * W-SU                         D.020611
002960*****    MOVE STRN-SU(CNT) TO STRN-SUT                            D.020611
002970*****    MOVE STRO-BT TO STRN-BT                                  D.020605
002980*****  ELSE                                                       D.020611
002990*****    COMPUTE STRN-SUT = -1 * STRO-SUT.                        D.020611
003000*****    MOVE STRO-SUT TO STRN-SUT                                D.020605
003010*****    COMPUTE STRN-BT = -1 * STRO-BT.                          D.020605
003020     COMPUTE STRN-SU(CNT) = -1 * W-SU.                            I.020611
003030     MOVE STRN-SU(CNT) TO STRN-SUT.                               I.020611
003040     MOVE STRO-BT TO STRN-BT.                                     I.020605
003050     COMPUTE STRN-KIN = STRN-SUT * STRN-BT.
003060     MOVE STRO-CSC TO STRN-CSC.
003070     MOVE STRO-DC TO STRN-DC.
003080     MOVE STRO-FT TO STRN-FT.
003090     MOVE STRO-BC TO STRN-BC.
003100     MOVE STRO-SOC TO STRN-SOC.
003110     MOVE STRO-TNC TO STRN-TNC.
003120     MOVE STRO-FKC TO STRN-FKC.
003130     MOVE STRO-SHZ TO STRN-SHZ.
003140     MOVE 1 TO STRN-FRC.
003150     MOVE STRO-BMC TO STRN-BMC.                                   I.020517
003160     MOVE STRO-BMNO TO STRN-BMNO.                                 I.020517
003170     MOVE STRO-SNC TO STRN-SNC.
003180     MOVE SPACE TO STRN-GBI.
003190     WRITE STRN-R.
003200     ADD STRN-SUT TO W-ASU.
003210     ADD STRN-KIN TO W-AKIN.
003220*
003230*****IF STRO-SNC = 0                                              D.020611
003240     IF STRO-DC NOT = 2
003250         IF STRO-DC = 0 OR 7
003260             ADD W-SU TO ZCM-SU(CNT)
003270           ELSE
003280             SUBTRACT W-SU FROM ZCM-SU(CNT).
003290*
003300     MOVE ZERO TO STRN-R.
003310     MOVE ZERO TO STRN-SU(01) STRN-SU(02) STRN-SU(03) STRN-SU(04)
003320                  STRN-SU(05) STRN-SU(06) STRN-SU(07) STRN-SU(08)
003330                  STRN-SU(09) STRN-SU(10).
003340     MOVE STRO-TCD TO STRN-TCD.
003350     MOVE STRO-TCD2 TO STRN-TCD2.
003360     MOVE ZCO-HCD TO STRN-HCD.
003370     MOVE STRO-SIZ TO STRN-SIZ.
003380*****IF STRO-SNC = 0                                              D.020611
003390*****    MOVE W-SU TO STRN-SU(CNT) STRN-SUT                       D.020611
003400*****  ELSE                                                       D.020611
003410*****    MOVE STRO-SUT TO STRN-SUT.                               D.020611
003420     MOVE W-SU TO STRN-SU(CNT) STRN-SUT.                          I.020611
003430     MOVE STRO-BT TO STRN-BT.
003440     COMPUTE STRN-KIN = STRN-SUT * STRN-BT.
003450     MOVE STRO-CSC TO STRN-CSC.
003460     MOVE STRO-DC TO STRN-DC.
003470*****IF STRO-SNC = 0                                              D.020611
003480     IF STRO-DC NOT = 2
003490         MOVE HI-FT TO STRN-FT
003500         IF STRN-FT = ZERO
003510             MOVE 255 TO COMPLETION-CODE
003520             DISPLAY E-ME8 E-ME99
003530             GO TO M-45.
003540     MOVE HI-BC TO STRN-BC.
003550     MOVE HI-BMC TO STRN-BMC.                                     I.020517
003560     MOVE HI-BMNO TO STRN-BMNO.                                   I.020517
003570     MOVE STRO-SOC TO STRN-SOC.
003580     MOVE STRO-TNC TO STRN-TNC.
003590     MOVE STRO-FKC TO STRN-FKC.
003600     MOVE STRO-SHZ TO STRN-SHZ.
003610     MOVE 1 TO STRN-FRC.
003620     MOVE STRO-SNC TO STRN-SNC.
003630     MOVE SPACE TO STRN-GBI.
003640     WRITE STRN-R.
003650     ADD STRN-SUT TO W-ASU.
003660     ADD STRN-KIN TO W-AKIN.
003670*
003680*****IF STRO-SNC = 1                                              D.020611
003690*****    GO TO M-45.                                              D.020611
003700     IF STRO-DC = 2
003710         GO TO M-45.
003720     IF STRO-DC = 0 OR 7
003730         ADD W-SU TO ZCO-CSU                                      I.020611
003740         SUBTRACT W-SU FROM ZCO-SU(CNT)
003750       ELSE
003760         SUBTRACT W-SU FROM ZCO-CSU.                              I.020611
003770         ADD W-SU TO ZCO-SU(CNT).
003780     REWRITE ZCO-R INVALID KEY
003790         MOVE 255 TO COMPLETION-CODE
003800         CLOSE STROF
003810         DISPLAY E-ME4 E-ME99.
003820 M-45.
003830     IF ERR-STAT = 255
003840         GO TO M-90.
003850     IF W-END = 0
003860         MOVE 1 TO W-END.
003870     COMPUTE W-SUD = -1 * ZCM-SU(CNT).
003880     IF ZCM-SU(CNT) < ZERO
003890         GO TO M-30.
003900 M-50.
003910     CLOSE STROF.
003920     IF W-RE = 1
003930         GO TO M-25.
003940     GO TO M-20.
003950 M-90.
003960     CLOSE STRNF.
003970     CLOSE ZCMF ZCOF.
003980     CLOSE HI-M.
003990     IF W-END = 0
004000         MOVE 255 TO COMPLETION-CODE
004010         DISPLAY E-ME2 E-ME99.
004020     IF (W-ASU NOT = ZERO) OR (W-AKIN NOT = ZERO)
004030         MOVE 255 TO COMPLETION-CODE
004040         DISPLAY E-ME7 E-ME99.
004050 M-95.
004060     DISPLAY C-CLEAR.
004070     STOP RUN.

000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. JSS50U.
000030*********************************************************
000040*    PROGRAM         :  生協荷札生成１                  *
000050*    PRINTER TYPE    :  JIPS                            *
000060*    SCREEN          :                                  *
000070*    COMPILE TYPE    :  COBOL                           *
000080*********************************************************
000090 ENVIRONMENT DIVISION.
000100 CONFIGURATION SECTION.
000110 SOURCE-COMPUTER. SYSTEM3100.
000120 OBJECT-COMPUTER. SYSTEM3100.
000130 INPUT-OUTPUT SECTION.
000140 FILE-CONTROL.
000150     SELECT SSTR ASSIGN TO SSTR-RDB
000160         ORGANIZATION INDEXED
000170         ACCESS MODE  DYNAMIC
000180         RECORD KEY   SSTR-KEY
000190         FILE STATUS IS ERR-STAT.
000200     SELECT JCON ASSIGN TO JCON-MSD
000210         ORGANIZATION INDEXED
000220         ACCESS MODE  RANDOM
000230         RECORD KEY   JCON7-KEY
000240         FILE STATUS IS ERR-STAT.
000250     SELECT HI2-M ASSIGN TO HI2-MSD
000260         ORGANIZATION INDEXED
000270         ACCESS MODE  DYNAMIC
000280         RECORD KEY   HI-KEY2
000290         FILE STATUS IS ERR-STAT.
000300     SELECT SK-HAT ASSIGN TO HAT-RDB
000310         ORGANIZATION INDEXED
000320         ACCESS MODE  RANDOM
000330         RECORD KEY   HAT-KEY.
000340     SELECT SNFW1 ASSIGN TO SNFW1-MSD
000350         ORGANIZATION INDEXED
000360         ACCESS MODE  DYNAMIC
000370         RECORD KEY   SNW1-KEY
000380         FILE STATUS IS ERR-STAT.
000390     SELECT SOKJW ASSIGN TO SOKJW-MSD
000400         ORGANIZATION INDEXED
000410         ACCESS MODE  DYNAMIC
000420         RECORD KEY   SOW-KEY
000430         FILE STATUS IS ERR-STAT.
000440 I-O-CONTROL.
000450     APPLY SHARED-MODE ON JCON  HI2-M  SK-HAT.
000460*
000470 DATA DIVISION.
000480 FILE SECTION.
000490     COPY    L-SSTR.
000500     COPY    L-JCON.
000510     COPY    LIHIM2.
000520     COPY    LSKHAT.
000530     COPY    LSNFW1.
000540     COPY    LSOKJW.
000550*
000560 WORKING-STORAGE SECTION.
000570 77  W-FILE             PIC  X(13).
000580 01  ERR-STAT           PIC  X(02).
000590 01  W-SCR.
000600     02  W-YMD.
000610         03  W-YEAR     PIC  9(04).
000620         03  W-MONTH    PIC  9(02).
000630         03  W-DAY      PIC  9(02).
000640 01  W-DATA.
000650     02  W-FLG          PIC  9(01).
000660     02  W-DATE         PIC  9(08).
000670     02  W-SYSYMD       PIC  9(08).
000680     02  F              REDEFINES  W-SYSYMD.
000690       03  W-SYSY       PIC  9(04).
000700       03  W-SYSM       PIC  9(02).
000710       03  W-SYSD       PIC  9(02).
000720     02  W-REN          PIC  9(06).
000730     02  CNT            PIC  9(02).
000740 01  W-SOKJW.
000750     02  W-TYCD         PIC  9(07).
000760     02  W-KICD         PIC  9(07).
000770     COPY    LSTAT.
000780     COPY    LWMSG.
000790     COPY    LWSIZC.
000800*
000810 SCREEN SECTION.
000820 SD  C-CRT
000830     END STATUS ESTAT.
000840 01  C-CLEAR.
000850     02  LINE   1  CLEAR SCREEN.
000860 01  DSP-AREA.
000870     02  D-TITLE    LINE  01    COLUMN  16  PIC  N(20)  VALUE
000880         NC"＊＊＊　　生協　荷札生成１　　　　＊＊＊".
000890     02  LINE  07.
000900       03  D-NOKI   COLUMN  24  PIC  N(04)  VALUE
000910         NC"納　期：".
000920       03  D-DATE   COLUMN  35  PIC  X(10)  VALUE
000930           "年  月  日".
000940 01  DSP-YMD.
000950     02  LINE  07.
000960       03  D-YMD.
000970         04  D-YEAR   COLUMN  33  PIC  9(02)  FROM  W-YEAR.
000980         04  D-MONTH  COLUMN  37  PIC  9(02)  FROM  W-MONTH.
000990         04  D-DAY    COLUMN  41  PIC  9(02)  FROM  W-DAY.
001000 01  MSG-AREA.
001010     02  LINE  24.
001020       03  MSG-01   COLUMN  15  PIC  N(13) VALUE
001030           NC"出荷指図データ未作成です。".
001040     COPY    LSSEM.
001050     COPY    LSMSG.
001060*
001070 PROCEDURE DIVISION.
001080 MAIN-01.
001090     PERFORM    INIT-RTN  THRU  INIT-EX.
001100     IF  W-FLG = 9
001110         GO TO    MAIN-03.
001120 MAIN-02.
001130     PERFORM    UPDT-RTN  THRU  UPDT-EX.
001140 MAIN-03.
001150     PERFORM    END-RTN  THRU  END-EX.
001160     STOP RUN.
001170*
001180*-----初期処理-----*
001190 INIT-RTN.
001200     INITIALIZE    W-DATA  W-SCR.
001210     DISPLAY    C-CLEAR  DSP-AREA.
001220     ACCEPT     W-SYSYMD  FROM  DATE.
001230     ADD     2000  TO  W-SYSY.
001240     OPEN INPUT    JCON.
001250     MOVE    "7 "  TO  JCON7-KEY.
001260     READ    JCON  WITH UNLOCK
001270         INVALID KEY    MOVE    ERR-STAT   TO  ERR-FLG
001280                        MOVE    "G"        TO  ERR-M
001290                        MOVE    "JCON"     TO  ERR-F
001300                        MOVE    JCON7-KEY  TO  ERR-K
001310                        MOVE    9          TO  W-FLG
001320                        DISPLAY    ERR-DIS  DISP-BUZ-B
001330                        GO TO    INIT-01.
001340     IF  JCON7-11 = ZERO
001350         MOVE    9  TO  W-FLG
001360         DISPLAY    MSG-01  DISP-BUZ-B
001370     ELSE
001380         COMPUTE    W-DATE = JCON7-11 + 20000000
001390         MOVE    W-DATE  TO  W-YMD
001400         DISPLAY    DSP-YMD.
001410 INIT-01.
001420     CLOSE    JCON.
001430     IF  W-FLG = 9
001440         GO TO    INIT-EX.
001450     OPEN OUTPUT    SNFW1  SOKJW.
001460     CLOSE    SNFW1  SOKJW.
001470 INIT-EX.
001480     EXIT.
001490*
001500*-----終了処理-----*
001510 END-RTN.
001520     IF  W-FLG = 9
001530         MOVE     255  TO  COMPLETION-CODE
001540     ELSE
001550         CLOSE    SSTR  HI2-M  SK-HAT  SNFW1  SOKJW.
001560 END-EX.
001570     EXIT.
001580*
001590*-----更新処理-----*
001600 UPDT-RTN.
001610     OPEN INPUT    SSTR   HI2-M  SK-HAT.
001620     OPEN I-O      SNFW1  SOKJW.
001630     MOVE    LOW-VALUE    TO  W-SOKJW.
001640     MOVE    0  TO  W-REN  W-FLG.
001650     SELECT    SSTR
001660*****    WHERE    SSTR-04 = W-YMD  AND SSTR-03 = 0                D.040402
001670         WHERE    SSTR-05 = W-YMD  AND SSTR-03 = 0                I.040402
001680              AND SSTR-09 < 999900 AND SSTR-17 = 0
001690              AND SSTR-14 NOT = 9
001700         ORDER BY    SSTR-06 SSTR-18.
001710 UPDT-01.
001720     READ    SSTR    NEXT RECORD  WITH UNLOCK
001730         AT END    SCRATCH    SSTR
001740                   GO TO    UPDT-EX.
001750     IF  NOT(SSTR-06 = W-TYCD AND SSTR-18 = W-KICD)
001760         IF  W-FLG = 0
001770             ADD     1  TO  W-REN
001780             MOVE    5  TO  W-FLG.
001790     MOVE    SSTR-09  TO  HI-MHCD  HI-HCD.
001800     READ    HI2-M    WITH UNLOCK
001810         INVALID KEY    INITIALIZE    HI-R
001820                        MOVE    20  TO  HI-ISU.
001830     IF  HI-ISU = 0
001840         MOVE    20  TO  HI-ISU.
001850     MOVE    SSTR-08  TO  HAT-KEY.
001860     READ    SK-HAT    WITH UNLOCK
001870         INVALID KEY    INITIALIZE    HAT-R.
001880     MOVE    0  TO  CNT.
001890 UPDT-02.
001900     ADD     1  TO CNT.
001910     IF  CNT > 10
001920         GO TO    UPDT-03.
001930     IF  SSTR-1111(CNT) = 0
001940         GO TO    UPDT-02.
001950     MOVE    0  TO  W-FLG.
001960     MOVE    SSTR-06  TO  SNW1-01.
001970     MOVE    SSTR-18  TO  SNW1-02.
001980     MOVE    HI-ISU   TO  SNW1-03.
001990     MOVE    SSTR-09  TO  SNW1-04.
002000     IF  SSTR-10 < 1 OR SSTR-10 > 4
002010         MOVE    ZERO  TO  SNW1-12  SNW1-05
002020     ELSE
002030         MOVE    HI-S(SSTR-10 CNT)     TO  SNW1-12
002040         MOVE    SIZE-CD(SSTR-10 CNT)  TO  SNW1-05.
002050     READ    SNFW1
002060             INVALID KEY    PERFORM    WSNW1-RTN  THRU  WSNW1-EX
002070         NOT INVALID KEY    PERFORM    RSNW1-RTN  THRU  RSNW1-EX.
002080     GO TO    UPDT-02.
002090 UPDT-03.
002100     IF  NOT(SSTR-06 = W-TYCD AND SSTR-18 = W-KICD)
002110         IF  W-FLG = 0
002120             PERFORM    WSOW-RTN  THRU  WSOW-EX.
002130     GO TO   UPDT-01.
002140 UPDT-EX.
002150     EXIT.
002160*
002170*-----生協送り状ワーク　追加処理-----*
002180 WSOW-RTN.
002190     MOVE    SSTR-06  TO  SOW-01  W-TYCD.
002200     MOVE    SSTR-18  TO  SOW-02  W-KICD.
002210     READ    SOKJW
002220             INVALID KEY    CONTINUE
002230         NOT INVALID KEY    GO TO    WSOW-EX.
002240     MOVE    SSTR-06  TO  SOW-01.
002250     MOVE    SSTR-18  TO  SOW-02.
002260     MOVE    SSTR-14  TO  SOW-03.
002270     MOVE    SSTR-07  TO  SOW-04.
002280     MOVE    SSTR-04(03:06)  TO  SOW-05.
002290     MOVE    SSTR-14D TO  SOW-06.
002300     MOVE    SSTR-15  TO  SOW-07.
002310     MOVE    ZERO     TO  SOW-08.
002320     MOVE    W-REN    TO  SOW-09.
002330     WRITE    SOW-R
002340         INVALID KEY    MOVE    "W"      TO  ERR-M
002350                        MOVE    "SOKJW"  TO  ERR-F
002360                        MOVE    SOW-KEY  TO  ERR-K
002370                        PERFORM    ERR-RTN  THRU  ERR-EX.
002380 WSOW-EX.
002390     EXIT.
002400*
002410*-----生協荷札ワーク１　追加処理-----*
002420 WSNW1-RTN.
002430     MOVE    SSTR-06  TO  SNW1-01.
002440     MOVE    SSTR-18  TO  SNW1-02.
002450     MOVE    HI-ISU   TO  SNW1-03.
002460     MOVE    SSTR-09  TO  SNW1-04.
002470     IF  SSTR-10 < 1 OR SSTR-10 > 4
002480         MOVE    ZERO  TO  SNW1-12  SNW1-05
002490     ELSE
002500         MOVE    HI-S(SSTR-10 CNT)     TO  SNW1-12
002510         MOVE    SIZE-CD(SSTR-10 CNT)  TO  SNW1-05.
002520     MOVE    SSTR-1111(CNT)  TO  SNW1-06.
002530     IF  SNW1-03 = 0
002540         MOVE    0  TO  SNW1-08
002550     ELSE
002560         COMPUTE    SNW1-08 = SNW1-06 / SNW1-03.
002570     COMPUTE    SNW1-09 = SNW1-06 - SNW1-08 * SNW1-03.
002580     MOVE    SNW1-09  TO  SNW1-16.                                I.041027
002590     MOVE    HAT-09   TO  SNW1-10.
002600     MOVE    W-REN    TO  SNW1-11.
002610     WRITE    SNW1-R
002620         INVALID KEY    MOVE    "W"       TO  ERR-M
002630                        MOVE    "SNFW1"   TO  ERR-F
002640                        MOVE    SNW1-KEY  TO  ERR-K
002650                        PERFORM    ERR-RTN  THRU  ERR-EX.
002660 WSNW1-EX.
002670     EXIT.
002680*
002690*-----生協荷札ワーク１　変更処理-----*
002700 RSNW1-RTN.
002710     ADD    SSTR-1111(CNT)  TO  SNW1-06.
002720     IF  SNW1-03 = 0
002730         MOVE    0  TO  SNW1-08
002740     ELSE
002750         COMPUTE    SNW1-08 = SNW1-06 / SNW1-03.
002760     COMPUTE    SNW1-09 = SNW1-06 - SNW1-08 * SNW1-03.
002770     MOVE    SNW1-09  TO  SNW1-16.                                I.041027
002780     REWRITE    SNW1-R
002790         INVALID KEY    MOVE    "R"       TO  ERR-M
002800                        MOVE    "SNFW1"   TO  ERR-F
002810                        MOVE    SNW1-KEY  TO  ERR-K
002820                        PERFORM    ERR-RTN  THRU  ERR-EX.
002830 RSNW1-EX.
002840     EXIT.
002850*
002860*****
002870     COPY    LPMSG.

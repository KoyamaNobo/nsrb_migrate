000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. KBD810.
000030*********************************************************
000040*    PROGRAM         :  発注入庫残ワーク作成            *
000050*    PRINTER TYPE    :  JIPS                            *
000060*    SCREEN          :  ______                          *
000070*    COMPILE TYPE    :  COBOL                           *
000080*    JS-SIGN         :  随時=0 , 月末=1                 *
000090*********************************************************
000100 ENVIRONMENT DIVISION.
000110 CONFIGURATION SECTION.
000120 SOURCE-COMPUTER. SYSTEM3100.
000130 OBJECT-COMPUTER. SYSTEM3100.
000140 INPUT-OUTPUT SECTION.
000150 FILE-CONTROL.
000160     COPY LIBCSE.
000170     SELECT HSHNF ASSIGN TO HSHN-MSD
000180         ORGANIZATION INDEXED
000190         ACCESS MODE DYNAMIC
000200         RECORD KEY HSHN-KEY
000210         FILE STATUS IS ERR-STAT.
000220     SELECT HSHF ASSIGN TO HSH1-MSD HSH2-MSD HSH3-MSD
000230         ORGANIZATION INDEXED
000240         ACCESS MODE DYNAMIC
000250         RECORD KEY HSH-KEY
000260         ALTERNATE RECORD KEY HSH-KEY2
000270         ALTERNATE RECORD KEY HSH-KEY3
000280         FILE STATUS IS ERR-STAT.
000290     SELECT HSHZF ASSIGN TO HSHZ-MSD.
000300 I-O-CONTROL.
000310     APPLY SHARED-MODE ON M-DATE
000320     APPLY SHARED-MODE ON HSHNF
000330     APPLY SHARED-MODE ON HSHF.
000340 DATA DIVISION.
000350 FILE SECTION.
000360     COPY LIBFDD.
000370     COPY LIHSHF.
000380     COPY LIHSHN.
000390 FD  HSHZF
000400     BLOCK  1 RECORDS
000410     LABEL RECORD IS STANDARD
000420     VALUE OF IDENTIFICATION WK0256ID.
000430 01  HSHZ-R.
000440     02  HSHZ-SCD         PIC  9(004).
000450     02  HSHZ-HCD         PIC  9(006).
000460     02  HSHZ-KEY         PIC  X(008).
000470     02  HSHZ-RNO   REDEFINES HSHZ-KEY.
000480       03  HSHZ-RSN       PIC  9(002).
000490       03  HSHZ-RNG       PIC  9(004).
000500       03  HSHZ-RND       PIC  9(002).
000510     02  HSHZ-HDD         PIC  9(008).
000520     02  HSHZ-HDDD  REDEFINES HSHZ-HDD.
000530       03  HSHZ-HNEN      PIC  9(004).
000540       03  HSHZ-HGP       PIC  9(004).
000550     02  HSHZ-HDDL  REDEFINES HSHZ-HDD.
000560       03  F              PIC  9(002).
000570       03  HSHZ-HNGPS     PIC  9(006).
000580     02  HSHZ-AHSUD.
000590       03  HSHZ-HSUD  OCCURS   4.                                 ｻｲｽﾞ
000600         04  HSHZ-AHSU  OCCURS  10.
000610           05  HSHZ-HSU   PIC S9(004).                            数量
000620     02  HSHZ-T           PIC  9(005).
000630     02  HSHZ-NDD         PIC  9(008).
000640     02  HSHZ-NDDD  REDEFINES HSHZ-NDD.
000650       03  HSHZ-NNG.
000660         04  HSHZ-NNEN    PIC  9(004).
000670         04  HSHZ-NNENL REDEFINES HSHZ-NNEN.
000680           05  HSHZ-NNEN1 PIC  9(002).
000690           05  HSHZ-NNEN2 PIC  9(002).
000700         04  HSHZ-NGET    PIC  9(002).
000710       03  HSHZ-NPEY      PIC  9(002).
000720     02  HSHZ-NDDL  REDEFINES HSHZ-NDD.
000730       03  F              PIC  9(002).
000740       03  HSHZ-NNGPS     PIC  9(006).
000750     02  HSHZ-ENGP        PIC  9(006).
000760     02  F                PIC  X(043).
000770     02  HSHZ-DATE        PIC  9(008).
000780 WORKING-STORAGE SECTION.
000790 77  JS-SIGN            PIC  9(001).
000800 77  WK0256ID           PIC  X(009) VALUE SPACE.
000810 01  STN-NO.
000820     02  STN-NO1        PIC  X(003).
000830     02  STN-NO2        PIC  X(003).
000840 01  W-FID.
000850     02  W-FID1         PIC  X(006) VALUE "WK0256".
000860     02  W-FID2         PIC  X(003).
000870 01  W-DATA.
000880     02  W-NGP.
000890       03  W-NEN        PIC  9(004).
000900       03  W-NENL REDEFINES W-NEN.
000910         04  W-NEN1     PIC  9(002).
000920         04  W-NEN2     PIC  9(002).
000930       03  W-GET        PIC  9(002).
000940       03  W-PEY        PIC  9(002).
000950     02  W-NGPD  REDEFINES W-NGP.
000960       03  F            PIC  9(002).
000970       03  W-NGPS       PIC  9(006).
000980     02  W-DATE         PIC  9(008).
000990     02  W-SNGP.
001000       03  W-SNEN       PIC  9(004).
001010       03  W-SNENL REDEFINES W-SNEN.
001020         04  W-SNEN1    PIC  9(002).
001030         04  W-SNEN2    PIC  9(002).
001040       03  W-SGET       PIC  9(002).
001050       03  W-SPEY       PIC  9(002).
001060     02  W-ENGP.
001070       03  W-ENEN       PIC  9(004).
001080       03  W-ENENL REDEFINES W-ENEN.
001090         04  W-ENEN1    PIC  9(002).
001100         04  W-ENEN2    PIC  9(002).
001110       03  W-EGET       PIC  9(002).
001120       03  W-EPEY       PIC  9(002).
001130     02  W-SHCD         PIC  9(006).
001140     02  W-EHCD         PIC  9(006).
001150     02  W-DMM          PIC  9(001).
001160     02  W-HCD          PIC  9(006).
001170     02  W-PC           PIC  9(001).
001180     02  W-S            PIC  9(001).
001190     02  CNT            PIC  9(002).
001200     02  W-ASUD.
001210       03  W-ASU   OCCURS   4.
001220         04  W-SUD   OCCURS  10.
001230           05  W-SU     PIC S9(004).
001240     02  CHK            PIC  9(001).
001250 01  W-EM               PIC  X(030) VALUE SPACE.
001260 01  W-FILE             PIC  X(013) VALUE SPACE.
001270 01  ERR-STAT           PIC  X(002).
001280     COPY LSTAT.
001290 SCREEN SECTION.
001300 SD  C-CRT
001310     END STATUS IS ESTAT.
001320 01  C-CLEAR.
001330     02  C-CL    LINE   1  CLEAR SCREEN.
001340 01  C-MID.
001350     02  LINE   3  COLUMN  12  PIC  N(020) VALUE
001360          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001370     02  LINE   4  COLUMN  12  PIC  N(020) VALUE
001380          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001390     02  LINE   5  COLUMN  12  PIC  N(020) VALUE
001400          NC"＊＊＊　　　　　　　　　　　　　　＊＊＊".
001410     02  LINE   6  COLUMN  12  PIC  N(020) VALUE
001420          NC"＊＊＊　　発注入庫残ワーク作成　　＊＊＊".
001430     02  LINE   7  COLUMN  12  PIC  N(020) VALUE
001440          NC"＊＊＊　　　　　　　　　　　　　　＊＊＊".
001450     02  LINE   8  COLUMN  12  PIC  N(020) VALUE
001460          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001470     02  LINE   9  COLUMN  12  PIC  N(020) VALUE
001480          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001490     02  LINE  12  COLUMN  19  PIC  X(031) VALUE
001500          "【       年   月   日 現在 　】".
001510     02  LINE  14  COLUMN  19  PIC  X(026) VALUE
001520          "品　名  000000   〜 999999".
001530     02  LINE  16  COLUMN  19  PIC  X(028) VALUE
001540          "納　期  00/00/00 〜 99/99/99".
001550     02  LINE  22  COLUMN  21  PIC  X(022) VALUE
001560          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001570 01  C-ACP.
001580     02  LINE  12.
001590       03  A-NEN   COLUMN  24   PIC  9(004)
001600            USING W-NEN                  NO IFC.
001610       03  A-GET   COLUMN  31   PIC  9(002)
001620            USING W-GET                  NO IFC.
001630       03  A-PEY   COLUMN  36   PIC  9(002)
001640            USING W-PEY   CHECK OVERFLOW NO IFC.
001650     02  LINE  14.
001660       03  A-SHCD1 COLUMN  27   PIC  9(006)
001670            USING W-SHCD  CHECK OVERFLOW NO IFC.
001680       03  A-EHCD1 COLUMN  39   PIC  9(006)
001690            USING W-EHCD  CHECK OVERFLOW NO IFC.
001700     02  LINE  16.
001710       03  A-SNEN  COLUMN  27   PIC  9(002)
001720            USING W-SNEN2                NO IFC.
001730       03  A-SGET  COLUMN  30   PIC  9(002)
001740            USING W-SGET                 NO IFC.
001750       03  A-SPEY  COLUMN  33   PIC  9(002)
001760            USING W-SPEY  CHECK OVERFLOW NO IFC.
001770       03  A-ENEN  COLUMN  39   PIC  9(002)
001780            USING W-ENEN2                NO IFC.
001790       03  A-EGET  COLUMN  42   PIC  9(002)
001800            USING W-EGET                 NO IFC.
001810       03  A-EPEY  COLUMN  45   PIC  9(002)
001820            USING W-EPEY  CHECK OVERFLOW NO IFC.
001830     02  A-DMM   LINE  22  COLUMN  38   PIC  9(001)
001840          USING W-DMM    CHECK OVERFLOW NO IFC.
001850 01  C-ERR.
001860     02  LINE  24.
001870       03  E-ME    COLUMN  15   PIC  X(030) FROM  W-EM.
001880     COPY LIBSCR.
001890     COPY LSSEM.
001900 PROCEDURE DIVISION.
001910 M-05.
001920     ACCEPT JS-SIGN.
001930     IF JS-SIGN > 1
001940         MOVE 255 TO COMPLETION-CODE
001950         STOP RUN.
001960     DISPLAY C-CLEAR.
001970     DISPLAY C-MID.
001980     COPY LIBCPR.
001990     MOVE ZERO TO W-DATA.
002000     IF JS-SIGN = 0
002010         ACCEPT W-NGPS FROM DATE
002020       ELSE
002030         MOVE DATE-02R TO W-NGPS.
002040     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
002050         ADD DATE-NC1 TO W-NEN.
002060     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
002070         ADD DATE-NC2 TO W-NEN.
002080     DISPLAY A-NEN A-GET A-PEY.
002090*
002100     PERFORM ACT-RTN THRU ACT-EX.
002110     IF COMPLETION-CODE = 255
002120         GO TO M-95.
002130*
002140     CALL "CBLSTNNO" USING STN-NO.
002150     MOVE STN-NO2 TO W-FID2.
002160     MOVE W-FID TO WK0256ID.
002170     OPEN OUTPUT HSHZF.
002180     OPEN INPUT HSHF.
002190     OPEN INPUT HSHNF.
002200 M-15.
002210     READ HSHF NEXT RECORD WITH UNLOCK AT END
002220         GO TO M-90.
002230     IF HSH-HDD > W-DATE
002240         GO TO M-15.
002250     IF HSH-HCD < W-SHCD
002260         GO TO M-15.
002270     IF HSH-HCD > W-EHCD
002280         GO TO M-90.
002290     IF HSH-NDD < W-SNGP OR > W-ENGP
002300         GO TO M-15.
002310     PERFORM NGP-RTN THRU NGP-EX.
002320     IF W-NGP NOT = ZERO
002330         IF W-NGP < W-DATE
002340             GO TO M-15.
002350     MOVE ZERO TO W-ASUD.
002360     MOVE HSH-AHSUD TO W-ASUD.
002370*
002380     MOVE SPACE TO HSHN-KEY.
002390     MOVE HSH-KEY TO HSHN-RNO.
002400     START HSHNF KEY NOT < HSHN-KEY INVALID KEY
002410         GO TO M-35.
002420 M-20.
002430     READ HSHNF NEXT RECORD WITH UNLOCK AT END
002440         GO TO M-35.
002450     IF HSH-KEY NOT =  HSHN-RNO
002460         GO TO M-35.
002470     IF HSHN-DATE > W-DATE
002480         GO TO M-35.
002490*
002500     MOVE ZERO TO W-S.
002510 M-25.
002520     ADD 1 TO W-S.
002530     IF W-S = 5
002540         GO TO M-20.
002550     MOVE ZERO TO CNT.
002560 M-30.
002570     ADD 1 TO CNT.
002580     IF CNT = 11
002590         GO TO M-25.
002600     SUBTRACT HSHN-SU(W-S,CNT) FROM W-SU(W-S,CNT).
002610     GO TO M-30.
002620 M-35.
002630     INITIALIZE HSHZ-R.
002640     MOVE HSH-SCD TO HSHZ-SCD.
002650     MOVE HSH-HCD TO HSHZ-HCD.
002660     MOVE HSH-KEY TO HSHZ-KEY.
002670     MOVE HSH-HDD TO HSHZ-HDD.
002680     MOVE W-ASUD TO HSHZ-AHSUD.
002690     MOVE HSH-T TO HSHZ-T.
002700     MOVE HSH-NDD TO HSHZ-NDD.
002710     MOVE HSH-ENGP TO HSHZ-ENGP.
002720     MOVE W-DATE TO HSHZ-DATE.
002730     WRITE HSHZ-R.
002740     IF CHK = 0
002750         MOVE 1 TO CHK.
002760     GO TO M-15.
002770 M-90.
002780     CLOSE HSHF.
002790     CLOSE HSHNF.
002800     CLOSE HSHZF.
002810     IF CHK = 0
002820         MOVE 255 TO COMPLETION-CODE
002830         MOVE "***  ＤＡＴＡ　なし  ***      " TO W-EM
002840         DISPLAY E-ME E-ME99.
002850 M-95.
002860     DISPLAY C-CLEAR.
002870     STOP RUN.
002880 ACT-RTN.
002890     MOVE ZERO TO W-SHCD W-SNGP.
002900     MOVE 999999 TO W-EHCD.
002910     MOVE 99999999 TO W-ENGP.
002920     GO TO ACT-300.
002930 ACT-005.
002940     ACCEPT A-NEN.
002950     IF ESTAT = PF9
002960         MOVE 255 TO COMPLETION-CODE
002970         GO TO ACT-EX.
002980     IF ESTAT NOT = NOC AND HTB AND SKP
002990         GO TO ACT-005.
003000     IF W-NEN < 2003
003010         GO TO ACT-005.
003020 ACT-010.
003030     ACCEPT A-GET
003040     IF ESTAT = PF9
003050         MOVE 255 TO COMPLETION-CODE
003060         GO TO ACT-EX.
003070     IF ESTAT = BTB
003080         GO TO ACT-005.
003090     IF ESTAT NOT = NOC AND HTB AND SKP
003100         GO TO ACT-010.
003110     IF W-GET NOT = 99
003120         IF W-GET < 1 OR > 12
003130             GO TO ACT-010.
003140 ACT-015.
003150     ACCEPT A-PEY
003160     IF ESTAT = PF9
003170         MOVE 255 TO COMPLETION-CODE
003180         GO TO ACT-EX.
003190     IF ESTAT = BTB
003200         GO TO ACT-010.
003210     IF ESTAT NOT = HTB AND SKP
003220         GO TO ACT-015.
003230     IF W-PEY NOT = 99
003240         IF W-PEY < 1 OR > 31
003250             GO TO ACT-015.
003260 ACT-020.
003270     ACCEPT A-SHCD1.
003280     DISPLAY E-CL.
003290     IF ESTAT = PF9
003300         MOVE 255 TO COMPLETION-CODE
003310         GO TO ACT-EX.
003320     IF ESTAT = BTB
003330         GO TO ACT-015.
003340     IF ESTAT NOT = HTB AND SKP
003350         GO TO ACT-020.
003360 ACT-040.
003370     ACCEPT A-EHCD1.
003380     IF ESTAT = PF9
003390         MOVE 255 TO COMPLETION-CODE
003400         GO TO ACT-EX.
003410     IF ESTAT = BTB
003420         GO TO ACT-020.
003430     IF ESTAT NOT = HTB AND SKP
003440         GO TO ACT-040.
003450     IF W-SHCD > W-EHCD
003460         GO TO ACT-040.
003470 ACT-180.
003480     ACCEPT A-SNEN.
003490     DISPLAY E-CL.
003500     IF ESTAT = PF9
003510         MOVE 255 TO COMPLETION-CODE
003520         GO TO ACT-EX.
003530     IF ESTAT = BTB
003540         GO TO ACT-020.
003550     IF ESTAT NOT = NOC AND HTB AND SKP
003560         GO TO ACT-180.
003570     MOVE ZERO TO W-SNEN1.
003580     IF W-SNEN2 = ZERO
003590         GO TO ACT-200.
003600     IF W-SNEN2 >= DATE-NF1 AND <= DATE-NT1
003610         ADD DATE-NC1 TO W-SNEN.
003620     IF W-SNEN2 >= DATE-NF2 AND <= DATE-NT2
003630         ADD DATE-NC2 TO W-SNEN.
003640 ACT-200.
003650     ACCEPT A-SGET.
003660     IF ESTAT = BTB
003670         GO TO ACT-180.
003680     IF ESTAT NOT = NOC AND HTB AND SKP
003690         GO TO ACT-200.
003700 ACT-220.
003710     ACCEPT A-SPEY.
003720     IF ESTAT = BTB
003730         GO TO ACT-200.
003740     IF ESTAT NOT = HTB AND SKP
003750         GO TO ACT-220.
003760 ACT-240.
003770     ACCEPT A-ENEN.
003780     DISPLAY E-CL.
003790     IF ESTAT = PF9
003800         MOVE 255 TO COMPLETION-CODE
003810         GO TO ACT-EX.
003820     IF ESTAT = BTB
003830         GO TO ACT-220.
003840     IF ESTAT NOT = NOC AND HTB AND SKP
003850         GO TO ACT-240.
003860     MOVE ZERO TO W-ENEN1.
003870     IF W-ENEN2 >= DATE-NF1 AND <= DATE-NT1
003880         ADD DATE-NC1 TO W-ENEN.
003890     IF W-ENEN2 >= DATE-NF2 AND <= DATE-NT2
003900         ADD DATE-NC2 TO W-ENEN.
003910 ACT-260.
003920     ACCEPT A-EGET.
003930     IF ESTAT = BTB
003940         GO TO ACT-240.
003950     IF ESTAT NOT = NOC AND HTB AND SKP
003960         GO TO ACT-260.
003970     IF W-EGET = 99
003980        IF W-ENEN2 = 99
003990             MOVE 99 TO W-ENEN1.
004000 ACT-280.
004010     ACCEPT A-EPEY.
004020     IF ESTAT = BTB
004030         GO TO ACT-260.
004040     IF ESTAT NOT = HTB AND SKP
004050         GO TO ACT-280.
004060     IF W-SNGP > W-ENGP
004070         GO TO ACT-240.
004080 ACT-300.
004090     ACCEPT A-DMM.
004100     IF ESTAT = BTB
004110         GO TO ACT-240.
004120     IF ESTAT NOT = HTB AND SKP
004130         GO TO ACT-300.
004140     IF W-DMM = 9
004150         GO TO ACT-005.
004160     IF W-DMM NOT = 1
004170         GO TO ACT-300.
004180     MOVE W-NGP TO W-DATE.
004190 ACT-EX.
004200     EXIT.
004210 NGP-RTN.
004220     MOVE ZERO TO W-NGP.
004230     IF HSH-ENGP = ZERO
004240         GO TO NGP-EX.
004250     MOVE HSH-ENGP TO W-NGPS.
004260     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
004270         ADD DATE-NC1 TO W-NEN.
004280     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
004290         ADD DATE-NC2 TO W-NEN.
004300 NGP-EX.
004310     EXIT.

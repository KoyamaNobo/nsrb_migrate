000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. KBY400.
000030*********************************************************
000040*    PROGRAM         :  仕入年間累積ワーク　作成        *
000050*    PRINTER TYPE    :  JIPS                            *
000060*    SCREEN          :  ******                          *
000070*    COMPILE TYPE    :  COBOL                           *
000080*********************************************************
000090 ENVIRONMENT DIVISION.
000100 CONFIGURATION SECTION.
000110 SOURCE-COMPUTER. SYSTEM3100.
000120 OBJECT-COMPUTER. SYSTEM3100.
000130 INPUT-OUTPUT SECTION.
000140 FILE-CONTROL.
000150     COPY LIBCSE.
000160     SELECT KBNO-M ASSIGN TO KBNO-MSD
000170         ORGANIZATION INDEXED
000180         ACCESS MODE RANDOM
000190         RECORD KEY BNO-KEY
000200         FILE STATUS IS ERR-STAT.
000210     SELECT JSSRYR ASSIGN TO JSSRY-MSD.
000220     SELECT JSSR-F ASSIGN TO JSSR-MSD.
000230 I-O-CONTROL.
000240     APPLY SHARED-MODE ON M-DATE
000250     APPLY SHARED-MODE ON KBNO-M.
000260 DATA DIVISION.
000270 FILE SECTION.
000280     COPY LIBFDD.
000290     COPY LIKBNO.
000300     COPY LSJSSW.
000310 FD  JSSRYR
000320     BLOCK  5 RECORDS
000330     LABEL RECORD IS STANDARD
000340     VALUE OF IDENTIFICATION "JSSRYR".
000350 01  JSSRY-R.
000360     02  JRY-DC.                                                  伝区
000370       03  JRY-DC1      PIC  9(001).
000380       03  JRY-DC2      PIC  9(001).
000390     02  JRY-NGP.                                                 日付
000400       03  JRY-NG.
000410         04  JRY-NEN    PIC  9(004).
000420         04  JRY-GET    PIC  9(002).
000430       03  JRY-PEY      PIC  9(002).
000440     02  JRY-SCD        PIC  9(004).
000450     02  JRY-JCD.                                                 材料C
000460       03  JRY-JCD12.
000470         04  JRY-JCD1   PIC  9(001).
000480         04  JRY-JCD2   PIC  9(002).
000490       03  JRY-JCD3     PIC  9(003).
000500     02  JRY-SU         PIC S9(007)V9(02).                        数量
000510     02  JRY-T          PIC S9(006)V9(02).                        単価
000520     02  JRY-KIN        PIC S9(008).
000530     02  JRY-SHZ        PIC S9(007).
000540     02  JRY-SNGP.                                                修正日
000550       03  JRY-SNG.
000560         04  JRY-SNEN   PIC  9(002).
000570         04  JRY-SGET   PIC  9(002).
000580       03  JRY-SPEY     PIC  9(002).
000590     02  JRY-SJCD       PIC  9(006).
000600     02  JRY-NHN        PIC  9(006).
000610     02  JRY-FC         PIC  9(001).
000620     02  JRY-YC         PIC  9(001).                              用途C
000630     02  JRY-TC         PIC  9(001).                              単位C
000640     02  JRY-HC         PIC  9(001).                              製品C
000650     02  JRY-SC         PIC  9(001).                              支払C
000660     02  JRY-BSC        PIC  9(001).
000670     02  JRY-BKC        PIC  9(002).
000680     02  F              PIC  X(016).
000690     02  JRY-KEY        PIC  X(007).
000700     02  JRY-CR         PIC  9(001).                              ﾁｪﾂｸﾘｽﾄC
000710 WORKING-STORAGE SECTION.
000720 77  WK0128ID           PIC  X(009) VALUE SPACE.
000730 01  STN-NO.
000740     02  STN-NO1        PIC  X(003).
000750     02  STN-NO2        PIC  X(003).
000760 01  W-FID.
000770     02  W-FID1         PIC  X(006) VALUE "WK0128".
000780     02  W-FID2         PIC  X(003).
000790 01  W-DATA.
000800     02  W-SNGM         PIC  9(006).
000810     02  W-ENGM         PIC  9(006).
000820     02  W-SNG          PIC  9(006).
000830     02  W-ENG          PIC  9(006).
000840     02  W-NG           PIC  9(006).
000850     02  W-NGD   REDEFINES W-NG.
000860       03  W-NEN        PIC  9(004).
000870       03  W-NENL  REDEFINES W-NEN.
000880         04  W-NEN1     PIC  9(002).
000890         04  W-NEN2     PIC  9(002).
000900       03  W-GET        PIC  9(002).
000910     02  W-NGL   REDEFINES W-NG.
000920       03  F            PIC  9(002).
000930       03  W-NGS        PIC  9(004).
000940     02  W-DATE.
000950       03  W-SNGD.
000960         04  W-SNEN     PIC  9(002).
000970         04  W-SGET     PIC  9(002).
000980       03  W-ENGD.
000990         04  W-ENEN     PIC  9(002).
001000         04  W-EGET     PIC  9(002).
001010     02  W-DMM          PIC  9(001).
001020     02  W-DC           PIC  9(001).
001030     02  W-FILE         PIC  X(013).
001040 01  ERR-STAT           PIC  X(002).
001050     COPY LSTAT.
001060 SCREEN SECTION.
001070 SD  C-CRT
001080     END STATUS IS ESTAT.
001090 01  C-CLEAR.
001100     02  C-CL    LINE   1  CLEAR SCREEN.
001110 01  C-MID.
001120     02  LINE   3  COLUMN  10  PIC  N(022) VALUE
001130          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001140     02  LINE   4  COLUMN  10  PIC  N(022) VALUE
001150          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001160     02  LINE   5  COLUMN  10  PIC  N(022) VALUE
001170          NC"＊＊＊　　　　　　　　　　　　　　　　＊＊＊".
001180     02  LINE   6  COLUMN  10  PIC  N(022) VALUE
001190          NC"＊＊＊　　仕入年間累積ワーク　作成　　＊＊＊".
001200     02  LINE   7  COLUMN  10  PIC  N(022) VALUE
001210          NC"＊＊＊　　　　　　　　　　　　　　　　＊＊＊".
001220     02  LINE   8  COLUMN  10  PIC  N(022) VALUE
001230          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001240     02  LINE   9  COLUMN  10  PIC  N(022) VALUE
001250          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001260     02  LINE  14  COLUMN  16  PIC  X(036) VALUE
001270          "データ年月  '  年  月  〜  '  年  月".
001280     02  LINE  16  COLUMN  16  PIC  X(036) VALUE
001290          "作表年月    '  年  月　〜　'  年  月".
001300     02  LINE  20  COLUMN  23  PIC  X(022) VALUE
001310          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001320 01  C-ACP.
001330     02  LINE  16.
001340       03  A-SNEN  COLUMN  29  PIC  9(002)
001350            USING W-SNEN  CHECK OVERFLOW NO IFC.
001360       03  A-SGET  COLUMN  33  PIC  9(002)
001370            USING W-SGET  CHECK OVERFLOW NO IFC.
001380       03  A-ENEN  COLUMN  44  PIC  9(002)
001390            USING W-ENEN  CHECK OVERFLOW NO IFC.
001400       03  A-EGET  COLUMN  48  PIC  9(002)
001410            USING W-EGET  CHECK OVERFLOW NO IFC.
001420     02  A-DMM   LINE  20  COLUMN  40  PIC  9(001)
001430          USING W-DMM   CHECK OVERFLOW NO IFC.
001440 01  C-DSP.
001450     02  D-NGM   LINE  14.
001460         03  COLUMN  29  PIC  9(002) FROM  W-SNEN.
001470         03  COLUMN  33  PIC Z9      FROM  W-SGET.
001480         03  COLUMN  44  PIC  9(002) FROM  W-ENEN.
001490         03  COLUMN  48  PIC Z9      FROM  W-EGET.
001500 01  C-ERR.
001510     02  LINE  24.
001520       03  E-ME1   COLUMN  15  PIC  X(017) VALUE
001530            "***  DATA ﾅｼ  ***".
001540       03  E-ME2   COLUMN  15  PIC  X(018) VALUE
001550            "***  KBNOM ﾅｼ  ***".
001560       03  E-ME3   COLUMN  15  PIC  X(027) VALUE
001570            "***  KBNOM REWRITE ｴﾗｰ  ***".
001580     COPY LSSEM.
001590     COPY LIBSCR.
001600 PROCEDURE DIVISION.
001610 M-05.
001620     DISPLAY C-CLEAR.
001630     DISPLAY C-MID.
001640     COPY LIBCPR.
001650     INITIALIZE W-DATA.
001660     MOVE D-NBNG TO W-NGS.
001670     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
001680         ADD DATE-NC1 TO W-NEN.
001690     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
001700         ADD DATE-NC2 TO W-NEN.
001710     SUBTRACT 1 FROM W-GET.
001720     IF W-GET = ZERO
001730         SUBTRACT 1 FROM W-NEN
001740         MOVE 12 TO W-GET.
001750     MOVE W-NG TO W-ENGM.
001760     MOVE W-NGS TO W-ENGD.
001770*
001780     OPEN INPUT JSSRYR.
001790     READ JSSRYR AT END
001800         MOVE 255 TO COMPLETION-CODE
001810         CLOSE JSSRYR
001820         GO TO M-95.
001830     MOVE JRY-NG TO W-NG W-SNGM.
001840     CLOSE JSSRYR.
001850     MOVE W-NGS TO W-SNGD.
001860     DISPLAY D-NGM.
001870 M-10.
001880     ACCEPT A-SNEN.
001890     IF ESTAT = PF9
001900         MOVE 255 TO COMPLETION-CODE
001910         GO TO M-95.
001920     IF ESTAT NOT = HTB AND SKP
001930         GO TO M-10.
001940 M-15.
001950     ACCEPT A-SGET.
001960     IF ESTAT = BTB
001970         GO TO M-10.
001980     IF ESTAT NOT = HTB AND SKP
001990         GO TO M-15.
002000     IF W-SGET < 1 OR > 12
002010         GO TO M-15.
002020     MOVE ZERO TO W-NG.
002030     MOVE W-SNGD TO W-NGS.
002040     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
002050         ADD DATE-NC1 TO W-NEN.
002060     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
002070         ADD DATE-NC2 TO W-NEN.
002080     MOVE W-NG TO W-SNG.
002090     IF W-SNG < W-SNGM OR > W-ENGM
002100         GO TO M-10.
002110 M-20.
002120     ACCEPT A-ENEN.
002130     IF ESTAT = BTB
002140         GO TO M-15.
002150     IF ESTAT NOT = HTB AND SKP
002160         GO TO M-20.
002170 M-25.
002180     ACCEPT A-EGET.
002190     IF ESTAT = BTB
002200         GO TO M-20.
002210     IF ESTAT NOT = HTB AND SKP
002220         GO TO M-25.
002230     IF W-EGET < 1 OR > 12
002240         GO TO M-25.
002250     MOVE ZERO TO W-NG.
002260     MOVE W-ENGD TO W-NGS.
002270     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
002280         ADD DATE-NC1 TO W-NEN.
002290     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
002300         ADD DATE-NC2 TO W-NEN.
002310     MOVE W-NG TO W-ENG.
002320     IF W-ENG < W-SNGM OR > W-ENGM OR < W-SNG
002330         GO TO M-20.
002340 M-30.
002350     ACCEPT A-DMM.
002360     IF ESTAT = BTB
002370         GO TO M-25.
002380     IF ESTAT NOT = HTB AND SKP
002390         GO TO M-30.
002400     IF W-DMM = 9
002410         GO TO M-10.
002420     IF W-DMM NOT = 1
002430         GO TO M-30.
002440*
002450     CALL "CBLSTNNO" USING STN-NO.
002460     MOVE STN-NO2 TO W-FID2.
002470     MOVE W-FID TO WK0128ID.
002480     OPEN INPUT JSSRYR.
002490     OPEN OUTPUT JSSR-F.
002500 M-35.
002510     READ JSSRYR AT END
002520         GO TO M-90.
002530     IF JRY-NG > W-ENG
002540         GO TO M-35.
002550     IF JRY-NG < W-SNG
002560         GO TO M-35.
002570     IF JRY-DC = 30
002580         GO TO M-35.
002590     IF ZERO = JRY-SU AND JRY-KIN
002600         GO TO M-35.
002610*
002620     INITIALIZE JSSR-R.
002630     MOVE JSSRY-R TO JSSR-R.
002640     WRITE JSSR-R.
002650     IF W-DC = 0
002660         MOVE 1 TO W-DC.
002670     GO TO M-35.
002680 M-90.
002690     CLOSE JSSRYR.
002700     CLOSE JSSR-F.
002710     IF W-DC = 0
002720         MOVE 255 TO COMPLETION-CODE
002730         DISPLAY E-ME1 E-ME99
002740         GO TO M-95.
002750*
002760     OPEN I-O KBNO-M.
002770     MOVE SPACE TO BNO-KEY.
002780     MOVE "01" TO BNO-KEYD.
002790     READ KBNO-M INVALID KEY
002800         CLOSE KBNO-M
002810         MOVE 255 TO COMPLETION-CODE
002820         DISPLAY E-ME2 E-ME99
002830         GO TO M-95.
002840     MOVE W-SNG TO BNO-SNG.
002850     MOVE W-ENG TO BNO-ENG.
002860     REWRITE KBNO-R INVALID KEY
002870         MOVE 255 TO COMPLETION-CODE
002880         DISPLAY E-ME3 E-ME99.
002890     CLOSE KBNO-M.
002900 M-95.
002910     DISPLAY C-CLEAR.
002920     STOP RUN.

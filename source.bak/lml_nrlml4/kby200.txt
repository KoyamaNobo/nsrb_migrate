000010 IDENTIFICATION DIVISION.
000020 PROGRAM-ID. KBY200.
000030*********************************************************
000040*    PROGRAM         :  購買品目別年間累積ワーク　作成  *
000050*    PRINTER TYPE    :  JIPS                            *
000060*    SCREEN          :  ******                          *
000070*        変更　　　  :  99/05/20                        *
000080*    COMPILE TYPE    :  COBOL                           *
000090*********************************************************
000100 ENVIRONMENT DIVISION.
000110 CONFIGURATION SECTION.
000120 SOURCE-COMPUTER. SYSTEM3100.
000130 OBJECT-COMPUTER. SYSTEM3100.
000140 INPUT-OUTPUT SECTION.
000150 FILE-CONTROL.
000160     COPY LIBCSE.
000170     SELECT KBNO-M ASSIGN TO KBNO-MSD
000180         ORGANIZATION INDEXED
000190         ACCESS MODE RANDOM
000200         RECORD KEY BNO-KEY
000210         FILE STATUS IS ERR-STAT.
000220     SELECT JSSR-F ASSIGN TO JSSR-MSD.
000230     SELECT JSY-F  ASSIGN TO JSY-MSD.
000240 I-O-CONTROL.
000250     APPLY SHARED-MODE ON M-DATE
000260     APPLY SHARED-MODE ON KBNO-M.
000270 DATA DIVISION.
000280 FILE SECTION.
000290     COPY LIBFDD.
000300     COPY LIKBNO.
000310 FD  JSSR-F
000320     BLOCK  5 RECORDS
000330     LABEL RECORD IS STANDARD
000340     VALUE OF IDENTIFICATION "JSSRYR".
000350 01  JSSR-R.
000360     02  JR-DC.                                                   伝区
000370       03  JR-DC1       PIC  9(001).
000380       03  JR-DC2       PIC  9(001).
000390     02  JR-NGP.                                                  日付
000400       03  JR-NG.
000410         04  JR-NEN     PIC  9(004).
000420         04  JR-GET     PIC  9(002).
000430       03  JR-PEY       PIC  9(002).
000440     02  JR-SCD         PIC  9(004).
000450     02  JR-JCD.                                                  材料C
000460       03  JR-JCD12.
000470         04  JR-JCD1    PIC  9(001).
000480         04  JR-JCD2    PIC  9(002).
000490       03  JR-JCD3      PIC  9(003).
000500     02  JR-SU          PIC S9(007)V9(02).                        数量
000510     02  JR-T           PIC S9(006)V9(02).                        単価
000520     02  JR-KIN         PIC S9(008).
000530     02  JR-SHZ         PIC S9(007).                              I.990531
000540*****02  JR-SHZ         PIC S9(006).                              D.990531
000550     02  JR-SNGP.                                                 修正日
000560       03  JR-SNG.
000570         04  JR-SNEN    PIC  9(002).
000580         04  JR-SGET    PIC  9(002).
000590       03  JR-SPEY      PIC  9(002).
000600     02  JR-SJCD        PIC  9(006).
000610     02  JR-NHN         PIC  9(006).
000620     02  JR-FC          PIC  9(001).
000630     02  JR-YC          PIC  9(001).                              用途C
000640     02  JR-TC          PIC  9(001).                              単位C
000650     02  JR-HC          PIC  9(001).                              製品C
000660     02  JR-SC          PIC  9(001).                              支払C
000670     02  JR-BSC         PIC  9(001).
000680     02  JR-BKC         PIC  9(002).
000690     02  F              PIC  X(016).                              I.990531
000700*****02  F              PIC  X(017).                              D.990531
000710     02  JR-KEY         PIC  X(007).
000720     02  JR-CR          PIC  9(001).                              ﾁｪﾂｸﾘｽﾄC
000730 FD  JSY-F
000740     BLOCK  4 RECORDS
000750     LABEL RECORD IS STANDARD
000760     VALUE OF IDENTIFICATION WK0064ID.
000770 01  JSY-R.
000780     02  JY-NG          PIC  9(006).
000790     02  JY-BCD         PIC  9(001).                              部門ｺｰﾄﾞ
000800     02  JY-SEC         PIC  9(001).                              製品区分
000810     02  JY-HINC        PIC  9(002).                              品目区分
000820     02  JY-KIN         PIC S9(010).                              金額
000830     02  F              PIC  X(044).
000840 WORKING-STORAGE SECTION.
000850 77  WK0064ID           PIC  X(009) VALUE SPACE.
000860 01  STN-NO.
000870     02  STN-NO1        PIC  X(003).
000880     02  STN-NO2        PIC  X(003).
000890 01  W-FID.
000900     02  W-FID1         PIC  X(006) VALUE "WK0064".
000910     02  W-FID2         PIC  X(003).
000920 01  W-DATA.
000930     02  W-SNGM         PIC  9(006).
000940     02  W-ENGM         PIC  9(006).
000950     02  W-SNG          PIC  9(006).
000960     02  W-ENG          PIC  9(006).
000970     02  W-NG           PIC  9(006).
000980     02  W-NGD   REDEFINES W-NG.
000990       03  W-NEN        PIC  9(004).
001000       03  W-NENL  REDEFINES W-NEN.
001010         04  W-NEN1     PIC  9(002).
001020         04  W-NEN2     PIC  9(002).
001030       03  W-GET        PIC  9(002).
001040     02  W-NGL   REDEFINES W-NG.
001050       03  F            PIC  9(002).
001060       03  W-NGS        PIC  9(004).
001070     02  W-DATE.
001080       03  W-SNGD.
001090         04  W-SNEN     PIC  9(002).
001100         04  W-SGET     PIC  9(002).
001110       03  W-ENGD.
001120         04  W-ENEN     PIC  9(002).
001130         04  W-EGET     PIC  9(002).
001140     02  W-DMM          PIC  9(001).
001150     02  W-DC           PIC  9(001).
001160     02  W-BC.
001170       03  W-BC1        PIC  9(001).
001180       03  W-BC2        PIC  9(002).
001190     02  W-FILE         PIC  X(013).
001200 01  ERR-STAT           PIC  X(002).
001210     COPY LSTAT.
001220 SCREEN SECTION.
001230 SD  C-CRT
001240     END STATUS IS ESTAT.
001250 01  C-CLEAR.
001260     02  C-CL    LINE   1  CLEAR SCREEN.
001270 01  C-MID.
001280     02  LINE   3  COLUMN  10  PIC  N(023) VALUE
001290          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001300     02  LINE   4  COLUMN  10  PIC  N(023) VALUE
001310          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001320     02  LINE   5  COLUMN  10  PIC  N(023) VALUE
001330          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
001340     02  LINE   6  COLUMN  10  PIC  N(023) VALUE
001350          NC"＊＊＊　　品目別年間累積ワーク　作成　　＊＊＊".
001360     02  LINE   7  COLUMN  10  PIC  N(023) VALUE
001370          NC"＊＊＊　　　　　　　　　　　　　　　　　＊＊＊".
001380     02  LINE   8  COLUMN  10  PIC  N(023) VALUE
001390          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001400     02  LINE   9  COLUMN  10  PIC  N(023) VALUE
001410          NC"＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊＊".
001420     02  LINE  14  COLUMN  15  PIC  X(036) VALUE
001430          "データ年月  '  年  月  〜  '  年  月".
001440     02  LINE  16  COLUMN  15  PIC  X(036) VALUE
001450          "作表年月    '  年  月　〜　'  年  月".
001460     02  LINE  20  COLUMN  22  PIC  X(022) VALUE
001470          "確認  OK=1 NO=9   ﾘﾀｰﾝ".
001480 01  C-ACP.
001490     02  LINE  16.
001500       03  A-SNEN  COLUMN  28  PIC  9(002)
001510            USING W-SNEN  CHECK OVERFLOW NO IFC.
001520       03  A-SGET  COLUMN  32  PIC  9(002)
001530            USING W-SGET  CHECK OVERFLOW NO IFC.
001540       03  A-ENEN  COLUMN  43  PIC  9(002)
001550            USING W-ENEN  CHECK OVERFLOW NO IFC.
001560       03  A-EGET  COLUMN  47  PIC  9(002)
001570            USING W-EGET  CHECK OVERFLOW NO IFC.
001580     02  A-DMM   LINE  20  COLUMN  39  PIC  9(001)
001590          USING W-DMM   CHECK OVERFLOW NO IFC.
001600 01  C-DSP.
001610     02  D-NGM   LINE  14.
001620         03  COLUMN  28  PIC  9(002) FROM  W-SNEN.
001630         03  COLUMN  32  PIC Z9      FROM  W-SGET.
001640         03  COLUMN  43  PIC  9(002) FROM  W-ENEN.
001650         03  COLUMN  47  PIC Z9      FROM  W-EGET.
001660 01  C-ERR.
001670     02  LINE  24.
001680       03  E-ME1   COLUMN  15  PIC  X(017) VALUE
001690            "***  DATA ﾅｼ  ***".
001700       03  E-ME2   COLUMN  15  PIC  X(018) VALUE
001710            "***  KBNOM ﾅｼ  ***".
001720       03  E-ME3   COLUMN  15  PIC  X(027) VALUE
001730            "***  KBNOM REWRITE ｴﾗｰ  ***".
001740     COPY LSSEM.
001750     COPY LIBSCR.
001760 PROCEDURE DIVISION.
001770 M-05.
001780     DISPLAY C-CLEAR.
001790     DISPLAY C-MID.
001800     COPY LIBCPR.
001810     INITIALIZE W-DATA.
001820     MOVE D-NBNG TO W-NGS.
001830     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
001840         ADD DATE-NC1 TO W-NEN.
001850     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
001860         ADD DATE-NC2 TO W-NEN.
001870     SUBTRACT 1 FROM W-GET.
001880     IF W-GET = ZERO
001890         SUBTRACT 1 FROM W-NEN
001900         MOVE 12 TO W-GET.
001910     MOVE W-NG TO W-ENGM.
001920     MOVE W-NGS TO W-ENGD.
001930*
001940     OPEN INPUT JSSR-F.
001950     READ JSSR-F AT END
001960         MOVE 255 TO COMPLETION-CODE
001970         CLOSE JSSR-F
001980         GO TO M-95.
001990     MOVE JR-NG TO W-NG W-SNGM.
002000     CLOSE JSSR-F.
002010     MOVE W-NGS TO W-SNGD.
002020     DISPLAY D-NGM.
002030 M-10.
002040     ACCEPT A-SNEN.
002050     IF ESTAT = PF9
002060         MOVE 255 TO COMPLETION-CODE
002070         GO TO M-95.
002080     IF ESTAT NOT = HTB AND SKP
002090         GO TO M-10.
002100 M-15.
002110     ACCEPT A-SGET.
002120     IF ESTAT = BTB
002130         GO TO M-10.
002140     IF ESTAT NOT = HTB AND SKP
002150         GO TO M-15.
002160     IF W-SGET < 1 OR > 12
002170         GO TO M-15.
002180     MOVE ZERO TO W-NG.
002190     MOVE W-SNGD TO W-NGS.
002200     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
002210         ADD DATE-NC1 TO W-NEN.
002220     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
002230         ADD DATE-NC2 TO W-NEN.
002240     MOVE W-NG TO W-SNG.
002250     IF W-SNG < W-SNGM OR > W-ENGM
002260         GO TO M-10.
002270 M-20.
002280     ACCEPT A-ENEN.
002290     IF ESTAT = BTB
002300         GO TO M-15.
002310     IF ESTAT NOT = HTB AND SKP
002320         GO TO M-20.
002330 M-25.
002340     ACCEPT A-EGET.
002350     IF ESTAT = BTB
002360         GO TO M-20.
002370     IF ESTAT NOT = HTB AND SKP
002380         GO TO M-25.
002390     IF W-EGET < 1 OR > 12
002400         GO TO M-25.
002410     MOVE ZERO TO W-NG.
002420     MOVE W-ENGD TO W-NGS.
002430     IF W-NEN2 >= DATE-NF1 AND <= DATE-NT1
002440         ADD DATE-NC1 TO W-NEN.
002450     IF W-NEN2 >= DATE-NF2 AND <= DATE-NT2
002460         ADD DATE-NC2 TO W-NEN.
002470     MOVE W-NG TO W-ENG.
002480     IF W-ENG < W-SNGM OR > W-ENGM OR < W-SNG
002490         GO TO M-20.
002500 M-30.
002510     ACCEPT A-DMM.
002520     IF ESTAT = BTB
002530         GO TO M-25.
002540     IF ESTAT NOT = HTB AND SKP
002550         GO TO M-30.
002560     IF W-DMM = 9
002570         GO TO M-10.
002580     IF W-DMM NOT = 1
002590         GO TO M-30.
002600*
002610     CALL "CBLSTNNO" USING STN-NO.
002620     MOVE STN-NO2 TO W-FID2.
002630     MOVE W-FID TO WK0064ID.
002640     OPEN INPUT JSSR-F.
002650     OPEN OUTPUT JSY-F.
002660 M-35.
002670     READ JSSR-F AT END
002680         GO TO M-90.
002690     IF JR-NG > W-ENG
002700         GO TO M-35.
002710*****    GO TO M-90.
002720     IF JR-NG < W-SNG
002730         GO TO M-35.
002740     IF JR-JCD = 999000
002750         GO TO M-35.
002760     IF JR-KIN = ZERO
002770         GO TO M-35.
002780     IF JR-DC1 = 3
002790         GO TO M-35.
002800*
002810     MOVE JR-JCD12 TO W-BC.
002820     IF W-BC2 < 05
002830         MOVE 00 TO W-BC2.
002840     IF W-BC2 > 04 AND < 10
002850         MOVE 05 TO W-BC2.
002860     IF W-BC2 > 09 AND < 15
002870         MOVE 10 TO W-BC2.
002880     IF W-BC2 > 14 AND < 20
002890         MOVE 15 TO W-BC2.
002900     IF W-BC2 > 19 AND < 25
002910         MOVE 20 TO W-BC2.
002920     IF W-BC2 > 24 AND < 30
002930         MOVE 25 TO W-BC2.
002940     IF W-BC2 > 29 AND < 35
002950         MOVE 30 TO W-BC2.
002960     IF W-BC2 > 34 AND < 40
002970         MOVE 35 TO W-BC2.
002980     IF W-BC2 > 39 AND < 45
002990         MOVE 40 TO W-BC2.
003000     IF W-BC2 > 44 AND < 50
003010         MOVE 45 TO W-BC2.
003020     IF W-BC2 > 50 AND < 62
003030         MOVE 60 TO W-BC2.
003040     IF W-BC2 > 61 AND < 64
003050         MOVE 62 TO W-BC2.
003060     IF W-BC2 > 63 AND < 68
003070         MOVE 64 TO W-BC2.
003080     IF W-BC2 > 67 AND < 80
003090         MOVE 68 TO W-BC2.
003100     IF W-BC2 > 79 AND < 82
003110         MOVE 80 TO W-BC2.
003120     IF W-BC2 > 81 AND < 84
003130         MOVE 82 TO W-BC2.
003140     IF W-BC2 > 83 AND < 90
003150         MOVE 84 TO W-BC2.
003160     IF W-BC2 > 89 AND < 99
003170         MOVE 90 TO W-BC2.
003180     IF W-BC2 = 99
003190         MOVE 99 TO W-BC2.
003200*
003210     MOVE ZERO TO JSY-R.
003220     MOVE JR-NG TO JY-NG.
003230     MOVE W-BC1 TO JY-BCD.
003240     MOVE W-BC2 TO JY-HINC.
003250     MOVE JR-KIN TO JY-KIN.
003260     WRITE JSY-R.
003270     IF W-DC = 0
003280         MOVE 1 TO W-DC.
003290     GO TO M-35.
003300 M-90.
003310     CLOSE JSSR-F.
003320     CLOSE JSY-F.
003330     IF W-DC = 0
003340         MOVE 255 TO COMPLETION-CODE
003350         DISPLAY E-ME1 E-ME99
003360         GO TO M-95.
003370*
003380     OPEN I-O KBNO-M.
003390     MOVE SPACE TO BNO-KEY.
003400     MOVE "01" TO BNO-KEYD.
003410     READ KBNO-M INVALID KEY
003420         CLOSE KBNO-M
003430         MOVE 255 TO COMPLETION-CODE
003440         DISPLAY E-ME2 E-ME99
003450         GO TO M-95.
003460     MOVE W-SNG TO BNO-SNG.
003470     MOVE W-ENG TO BNO-ENG.
003480     REWRITE KBNO-R INVALID KEY
003490         MOVE 255 TO COMPLETION-CODE
003500         DISPLAY E-ME3 E-ME99.
003510     CLOSE KBNO-M.
003520 M-95.
003530     DISPLAY C-CLEAR.
003540     STOP RUN.
